<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NU-6 Phoneme Scoring</title>

    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- html2canvas for PNG Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Chart.js for Critical Difference Graph -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .phoneme-btn { transition: all 0.2s; }
        .ipa-text { font-family: 'Times New Roman', serif; }
        .tab-btn { transition: all 0.2s; }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            .page-break { page-break-before: always; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script>
        // --- LOCAL INDEXEDDB CONFIGURATION (NO CLOUD) ---
        const DB_NAME = 'NU6_Audiology_DB';
        const DB_VERSION = 1;
        const STORE_NAME = 'patient_tests';

        const dbPromise = new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onerror = (event) => reject("Database error: " + event.target.errorCode);
            request.onsuccess = (event) => resolve(event.target.result);
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    const objectStore = db.createObjectStore(STORE_NAME, { keyPath: "id" });
                    objectStore.createIndex("patientName", "patientName", { unique: false });
                    objectStore.createIndex("cNumber", "cNumber", { unique: false });
                    objectStore.createIndex("testDate", "testDate", { unique: false });
                }
            };
        });

        const LocalDB = {
            saveTest: async (data) => {
                const db = await dbPromise;
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([STORE_NAME], "readwrite");
                    const store = transaction.objectStore(STORE_NAME);
                    const record = {
                        id: data.id || Date.now().toString(),
                        timestamp: new Date().toISOString(),
                        ...data
                    };
                    const request = store.put(record);
                    request.onsuccess = () => resolve(record.id);
                    request.onerror = () => reject(request.error);
                });
            },
            getAllTests: async () => {
                const db = await dbPromise;
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([STORE_NAME], "readonly");
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.getAll();
                    request.onsuccess = () => {
                        const sorted = request.result.sort((a, b) => new Date(b.testDate) - new Date(a.testDate));
                        resolve(sorted);
                    };
                    request.onerror = () => reject(request.error);
                });
            },
            deleteTest: async (id) => {
                const db = await dbPromise;
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([STORE_NAME], "readwrite");
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.delete(id);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            },
            getPatientHistory: async (cNumber) => {
                const allTests = await LocalDB.getAllTests();
                return allTests
                    .filter(t => t.cNumber && t.cNumber.toLowerCase() === cNumber.toLowerCase())
                    .sort((a, b) => new Date(a.testDate) - new Date(b.testDate));
            }
        };

        window.localDB = LocalDB;
    </script>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;
        const localDB = window.localDB;

        // --- INLINE ICONS ---
        const IconBase = ({ children, className, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                {children}
            </svg>
        );

        const Calculator = (props) => ( <IconBase {...props}><rect width="16" height="20" x="4" y="2" rx="2" /><line x1="8" x2="16" y1="6" y2="6" /><line x1="16" x2="16" y1="14" y2="18" /><path d="M16 10h.01" /><path d="M12 10h.01" /><path d="M8 10h.01" /><path d="M12 14h.01" /><path d="M8 14h.01" /><path d="M12 18h.01" /><path d="M8 18h.01" /></IconBase> );
        const Save = (props) => ( <IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase> );
        const FolderOpen = (props) => ( <IconBase {...props}><path d="m6 14 1.45-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.55 6a2 2 0 0 1-1.94 1.5H4a2 2 0 0 1-2-2V5c0-1.1.9-2 2-2h3.93a2 2 0 0 1 1.66.9l.82 1.2a2 2 0 0 0 1.66.9H18a2 2 0 0 1 2 2v2"/></IconBase> );
        const Trash2 = (props) => ( <IconBase {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase> );
        const CheckCircle2 = (props) => ( <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></IconBase> );
        const RotateCcw = (props) => ( <IconBase {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconBase> );
        const Check = (props) => ( <IconBase {...props}><polyline points="20 6 9 17 4 12"/></IconBase> );
        const X = (props) => ( <IconBase {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase> );
        const BarChart3 = (props) => ( <IconBase {...props}><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></IconBase> );
        const ListChecks = (props) => ( <IconBase {...props}><path d="m3 17 2 2 4-4"/><path d="m3 7 2 2 4-4"/><path d="M13 6h8"/><path d="M13 12h8"/><path d="M13 18h8"/></IconBase> );
        const WholeWord = (props) => ( <IconBase {...props}><rect width="20" height="14" x="2" y="5" rx="2"/><path d="M2 10h20"/></IconBase> );
        const AlertCircle = (props) => ( <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconBase> );
        const HelpCircle = (props) => ( <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></IconBase> );
        const Download = (props) => ( <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconBase> );
        const TrendingUp = (props) => ( <IconBase {...props}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></IconBase> );
        const Search = (props) => ( <IconBase {...props}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconBase> );
        const Loader = (props) => ( <IconBase {...props} className="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></IconBase> );
        const Database = (props) => ( <IconBase {...props}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></IconBase> );
        const FileUp = (props) => ( <IconBase {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M12 12v6"/><path d="m15 15-3-3-3 3"/></IconBase> );
        const HistoryIcon = (props) => ( <IconBase {...props}><path d="M3 3v5h5"/><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/><path d="M12 7v5l4 2"/></IconBase> );
        const Activity = (props) => ( <IconBase {...props}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></IconBase> );

        // --- PHONEME CLASSIFICATION DATA ---
        const PHONEME_MAP = {
            "f": "Fricative", "v": "Fricative", "θ": "Fricative", "ð": "Fricative",
            "s": "Fricative", "z": "Fricative", "ʃ": "Fricative", "ʒ": "Fricative",
            "h": "Fricative",
            "tʃ": "Affricate", "dʒ": "Affricate",
            "p": "Stop", "b": "Stop", "t": "Stop", "d": "Stop", "k": "Stop", "g": "Stop",
            "m": "Nasal", "n": "Nasal", "ŋ": "Nasal",
            "l": "Liquid", "r": "Liquid", "w": "Glide", "j": "Glide",
            "i": "Vowel", "ɪ": "Vowel", "eɪ": "Vowel", "ɛ": "Vowel", "æ": "Vowel",
            "u": "Vowel", "ʊ": "Vowel", "oʊ": "Vowel", "ɔ": "Vowel", "ɑ": "Vowel",
            "ʌ": "Vowel", "ɝ": "Vowel", "aɪ": "Vowel", "ɔɪ": "Vowel", "aʊ": "Vowel",
            "ə": "Vowel", "ɚ": "Vowel"
        };

        const PHONEME_GROUPS = {
            "High Frequency (Fricatives, Affricates, Stops)": ["Fricative", "Affricate", "Stop"],
            "Low Frequency (Nasals, Liquids, Glides, Vowels)": ["Nasal", "Liquid", "Glide", "Vowel"]
        };

        // --- DATA: NU-6 LISTS ---
        const LIST_1A = [
            { i: 1, w: "LAUD", p: ["l", "ɔ", "d"] }, { i: 2, w: "BOAT", p: ["b", "oʊ", "t"] }, { i: 3, w: "POOL", p: ["p", "u", "l"] }, { i: 4, w: "NAG", p: ["n", "æ", "g"] }, { i: 5, w: "LIMB", p: ["l", "ɪ", "m"] },
            { i: 6, w: "SHOUT", p: ["ʃ", "aʊ", "t"] }, { i: 7, w: "SUB", p: ["s", "ʌ", "b"] }, { i: 8, w: "VINE", p: ["v", "aɪ", "n"] }, { i: 9, w: "DIME", p: ["d", "aɪ", "m"] }, { i: 10, w: "GOOSE", p: ["g", "u", "s"] },
            { i: 11, w: "WHIP", p: ["w", "ɪ", "p"] }, { i: 12, w: "TOUGH", p: ["t", "ʌ", "f"] }, { i: 13, w: "PUFF", p: ["p", "ʌ", "f"] }, { i: 14, w: "KEEN", p: ["k", "i", "n"] }, { i: 15, w: "DEATH", p: ["d", "ɛ", "θ"] },
            { i: 16, w: "SELL", p: ["s", "ɛ", "l"] }, { i: 17, w: "TAKE", p: ["t", "eɪ", "k"] }, { i: 18, w: "FALL", p: ["f", "ɔ", "l"] }, { i: 19, w: "RAISE", p: ["r", "eɪ", "z"] }, { i: 20, w: "THIRD", p: ["θ", "ɝ", "d"] },
            { i: 21, w: "GAP", p: ["g", "æ", "p"] }, { i: 22, w: "FAT", p: ["f", "æ", "t"] }, { i: 23, w: "MET", p: ["m", "ɛ", "t"] }, { i: 24, w: "JAR", p: ["dʒ", "ɑ", "r"] }, { i: 25, w: "DOOR", p: ["d", "ɔ", "r"] },
            { i: 26, w: "LOVE", p: ["l", "ʌ", "v"] }, { i: 27, w: "SURE", p: ["ʃ", "ʊ", "r"] }, { i: 28, w: "KNOCK", p: ["n", "ɑ", "k"] }, { i: 29, w: "CHOICE", p: ["tʃ", "ɔɪ", "s"] }, { i: 30, w: "HASH", p: ["h", "æ", "ʃ"] },
            { i: 31, w: "LOT", p: ["l", "ɑ", "t"] }, { i: 32, w: "RAID", p: ["r", "eɪ", "d"] }, { i: 33, w: "HURL", p: ["h", "ɝ", "l"] }, { i: 34, w: "MOON", p: ["m", "u", "n"] }, { i: 35, w: "PAGE", p: ["p", "eɪ", "dʒ"] },
            { i: 36, w: "YES", p: ["j", "ɛ", "s"] }, { i: 37, w: "REACH", p: ["r", "i", "tʃ"] }, { i: 38, w: "KING", p: ["k", "ɪ", "ŋ"] }, { i: 39, w: "HOME", p: ["h", "oʊ", "m"] }, { i: 40, w: "RAG", p: ["r", "æ", "g"] },
            { i: 41, w: "WHICH", p: ["w", "ɪ", "tʃ"] }, { i: 42, w: "WEEK", p: ["w", "i", "k"] }, { i: 43, w: "SIZE", p: ["s", "aɪ", "z"] }, { i: 44, w: "MODE", p: ["m", "oʊ", "d"] }, { i: 45, w: "BEAN", p: ["b", "i", "n"] },
            { i: 46, w: "TIP", p: ["t", "ɪ", "p"] }, { i: 47, w: "CHALK", p: ["tʃ", "ɔ", "k"] }, { i: 48, w: "JAIL", p: ["dʒ", "eɪ", "l"] }, { i: 49, w: "BURN", p: ["b", "ɝ", "n"] }, { i: 50, w: "KITE", p: ["k", "aɪ", "t"] }
        ];

        const LIST_2A = [
            { i: 1, w: "PICK", p: ["p", "ɪ", "k"] }, { i: 2, w: "ROOM", p: ["r", "u", "m"] }, { i: 3, w: "NICE", p: ["n", "aɪ", "s"] }, { i: 4, w: "SAID", p: ["s", "ɛ", "d"] }, { i: 5, w: "FAIL", p: ["f", "eɪ", "l"] },
            { i: 6, w: "SOUTH", p: ["s", "aʊ", "θ"] }, { i: 7, w: "WHITE", p: ["w", "aɪ", "t"] }, { i: 8, w: "KEEP", p: ["k", "i", "p"] }, { i: 9, w: "DEAD", p: ["d", "ɛ", "d"] }, { i: 10, w: "LOAF", p: ["l", "oʊ", "f"] },
            { i: 11, w: "DAB", p: ["d", "æ", "b"] }, { i: 12, w: "NUMB", p: ["n", "ʌ", "m"] }, { i: 13, w: "JUICE", p: ["dʒ", "u", "s"] }, { i: 14, w: "CHIEF", p: ["tʃ", "i", "f"] }, { i: 15, w: "MERGE", p: ["m", "ɝ", "dʒ"] },
            { i: 16, w: "WAG", p: ["w", "æ", "g"] }, { i: 17, w: "RAIN", p: ["r", "eɪ", "n"] }, { i: 18, w: "WITCH", p: ["w", "ɪ", "tʃ"] }, { i: 19, w: "SOAP", p: ["s", "oʊ", "p"] }, { i: 20, w: "YOUNG", p: ["j", "ʌ", "ŋ"] },
            { i: 21, w: "TON", p: ["t", "ʌ", "n"] }, { i: 22, w: "KEG", p: ["k", "ɛ", "g"] }, { i: 23, w: "CALM", p: ["k", "ɑ", "m"] }, { i: 24, w: "TOOL", p: ["t", "u", "l"] }, { i: 25, w: "PIKE", p: ["p", "aɪ", "k"] },
            { i: 26, w: "MILL", p: ["m", "ɪ", "l"] }, { i: 27, w: "HUSH", p: ["h", "ʌ", "ʃ"] }, { i: 28, w: "SHACK", p: ["ʃ", "æ", "k"] }, { i: 29, w: "READ", p: ["r", "i", "d"] }, { i: 30, w: "ROT", p: ["r", "ɑ", "t"] },
            { i: 31, w: "HATE", p: ["h", "eɪ", "t"] }, { i: 32, w: "LIVE", p: ["l", "ɪ", "v"] }, { i: 33, w: "BOOK", p: ["b", "ʊ", "k"] }, { i: 34, w: "VOICE", p: ["v", "ɔɪ", "s"] }, { i: 35, w: "GAZE", p: ["g", "eɪ", "z"] },
            { i: 36, w: "PAD", p: ["p", "æ", "d"] }, { i: 37, w: "THOUGHT", p: ["θ", "ɔ", "t"] }, { i: 38, w: "BOUGHT", p: ["b", "ɔ", "t"] }, { i: 39, w: "TURN", p: ["t", "ɝ", "n"] }, { i: 40, w: "CHAIR", p: ["tʃ", "ɛ", "r"] },
            { i: 41, w: "LORE", p: ["l", "ɔ", "r"] }, { i: 42, w: "BITE", p: ["b", "aɪ", "t"] }, { i: 43, w: "HAZE", p: ["h", "eɪ", "z"] }, { i: 44, w: "MATCH", p: ["m", "æ", "tʃ"] }, { i: 45, w: "LEARN", p: ["l", "ɝ", "n"] },
            { i: 46, w: "SHAWL", p: ["ʃ", "ɔ", "l"] }, { i: 47, w: "DEEP", p: ["d", "i", "p"] }, { i: 48, w: "GIN", p: ["dʒ", "ɪ", "n"] }, { i: 49, w: "GOAL", p: ["g", "oʊ", "l"] }, { i: 50, w: "FAR", p: ["f", "ɑ", "r"] }
        ];

        const LIST_3A = [
            { i: 1, w: "BASE", p: ["b", "eɪ", "s"] }, { i: 2, w: "MESS", p: ["m", "ɛ", "s"] }, { i: 3, w: "CAUSE", p: ["k", "ɔ", "z"] }, { i: 4, w: "MOP", p: ["m", "ɑ", "p"] }, { i: 5, w: "GOOD", p: ["g", "ʊ", "d"] },
            { i: 6, w: "LUCK", p: ["l", "ʌ", "k"] }, { i: 7, w: "WALK", p: ["w", "ɔ", "k"] }, { i: 8, w: "YOUTH", p: ["j", "u", "θ"] }, { i: 9, w: "PAIN", p: ["p", "eɪ", "n"] }, { i: 10, w: "DATE", p: ["d", "eɪ", "t"] },
            { i: 11, w: "PEARL", p: ["p", "ɝ", "l"] }, { i: 12, w: "SEARCH", p: ["s", "ɝ", "tʃ"] }, { i: 13, w: "DITCH", p: ["d", "ɪ", "tʃ"] }, { i: 14, w: "TALK", p: ["t", "ɔ", "k"] }, { i: 15, w: "RING", p: ["r", "ɪ", "ŋ"] },
            { i: 16, w: "GERM", p: ["dʒ", "ɝ", "m"] }, { i: 17, w: "LIFE", p: ["l", "aɪ", "f"] }, { i: 18, w: "TEAM", p: ["t", "i", "m"] }, { i: 19, w: "LID", p: ["l", "ɪ", "d"] }, { i: 20, w: "POLE", p: ["p", "oʊ", "l"] },
            { i: 21, w: "RODE", p: ["r", "oʊ", "d"] }, { i: 22, w: "SHALL", p: ["ʃ", "æ", "l"] }, { i: 23, w: "LATE", p: ["l", "eɪ", "t"] }, { i: 24, w: "CHEEK", p: ["tʃ", "i", "k"] }, { i: 25, w: "BEG", p: ["b", "ɛ", "g"] },
            { i: 26, w: "GUN", p: ["g", "ʌ", "n"] }, { i: 27, w: "JUG", p: ["dʒ", "ʌ", "g"] }, { i: 28, w: "SHEEP", p: ["ʃ", "i", "p"] }, { i: 29, w: "FIVE", p: ["f", "aɪ", "v"] }, { i: 30, w: "RUSH", p: ["r", "ʌ", "ʃ"] },
            { i: 31, w: "RAT", p: ["r", "æ", "t"] }, { i: 32, w: "VOID", p: ["v", "ɔɪ", "d"] }, { i: 33, w: "WIRE", p: ["w", "aɪ", "r"] }, { i: 34, w: "HALF", p: ["h", "æ", "f"] }, { i: 35, w: "NOTE", p: ["n", "oʊ", "t"] },
            { i: 36, w: "WHEN", p: ["w", "ɛ", "n"] }, { i: 37, w: "NAME", p: ["n", "eɪ", "m"] }, { i: 38, w: "THIN", p: ["θ", "ɪ", "n"] }, { i: 39, w: "TELL", p: ["t", "ɛ", "l"] }, { i: 40, w: "BAR", p: ["b", "ɑ", "r"] },
            { i: 41, w: "MOUSE", p: ["m", "aʊ", "s"] }, { i: 42, w: "HIRE", p: ["h", "aɪ", "r"] }, { i: 43, w: "CAB", p: ["k", "æ", "b"] }, { i: 44, w: "HIT", p: ["h", "ɪ", "t"] }, { i: 45, w: "CHAT", p: ["tʃ", "æ", "t"] },
            { i: 46, w: "PHONE", p: ["f", "oʊ", "n"] }, { i: 47, w: "SOUP", p: ["s", "u", "p"] }, { i: 48, w: "DODGE", p: ["d", "ɑ", "dʒ"] }, { i: 49, w: "SEIZE", p: ["s", "i", "z"] }, { i: 50, w: "COOL", p: ["k", "u", "l"] }
        ];

        const LIST_4A = [
            { i: 1, w: "PASS", p: ["p", "æ", "s"] }, { i: 2, w: "DOLL", p: ["d", "ɑ", "l"] }, { i: 3, w: "BACK", p: ["b", "æ", "k"] }, { i: 4, w: "RED", p: ["r", "ɛ", "d"] }, { i: 5, w: "WASH", p: ["w", "ɔ", "ʃ"] },
            { i: 6, w: "SOUR", p: ["s", "aʊ", "r"] }, { i: 7, w: "BONE", p: ["b", "oʊ", "n"] }, { i: 8, w: "GET", p: ["g", "ɛ", "t"] }, { i: 9, w: "WHEAT", p: ["w", "i", "t"] }, { i: 10, w: "THUMB", p: ["θ", "ʌ", "m"] },
            { i: 11, w: "SALE", p: ["s", "eɪ", "l"] }, { i: 12, w: "YEARN", p: ["j", "ɝ", "n"] }, { i: 13, w: "WIFE", p: ["w", "aɪ", "f"] }, { i: 14, w: "SUCH", p: ["s", "ʌ", "tʃ"] }, { i: 15, w: "NEAT", p: ["n", "i", "t"] },
            { i: 16, w: "PEG", p: ["p", "ɛ", "g"] }, { i: 17, w: "MOB", p: ["m", "ɑ", "b"] }, { i: 18, w: "GAS", p: ["g", "æ", "s"] }, { i: 19, w: "CHECK", p: ["tʃ", "ɛ", "k"] }, { i: 20, w: "JOIN", p: ["dʒ", "ɔɪ", "n"] },
            { i: 21, w: "LEASE", p: ["l", "i", "s"] }, { i: 22, w: "LONG", p: ["l", "ɔ", "ŋ"] }, { i: 23, w: "CHAIN", p: ["tʃ", "eɪ", "n"] }, { i: 24, w: "KILL", p: ["k", "ɪ", "l"] }, { i: 25, w: "HOLE", p: ["h", "oʊ", "l"] },
            { i: 26, w: "LEAN", p: ["l", "i", "n"] }, { i: 27, w: "TAPE", p: ["t", "eɪ", "p"] }, { i: 28, w: "TIRE", p: ["t", "aɪ", "r"] }, { i: 29, w: "DIP", p: ["d", "ɪ", "p"] }, { i: 30, w: "ROSE", p: ["r", "oʊ", "z"] },
            { i: 31, w: "CAME", p: ["k", "eɪ", "m"] }, { i: 32, w: "FIT", p: ["f", "ɪ", "t"] }, { i: 33, w: "MAKE", p: ["m", "eɪ", "k"] }, { i: 34, w: "VOTE", p: ["v", "oʊ", "t"] }, { i: 35, w: "JUDGE", p: ["dʒ", "ʌ", "dʒ"] },
            { i: 36, w: "FOOD", p: ["f", "u", "d"] }, { i: 37, w: "RIPE", p: ["r", "aɪ", "p"] }, { i: 38, w: "HAVE", p: ["h", "æ", "v"] }, { i: 39, w: "ROUGH", p: ["r", "ʌ", "f"] }, { i: 40, w: "KICK", p: ["k", "ɪ", "k"] },
            { i: 41, w: "LOSE", p: ["l", "u", "z"] }, { i: 42, w: "NEAR", p: ["n", "i", "r"] }, { i: 43, w: "PERCH", p: ["p", "ɝ", "tʃ"] }, { i: 44, w: "SHIRT", p: ["ʃ", "ɝ", "t"] }, { i: 45, w: "BATH", p: ["b", "æ", "θ"] },
            { i: 46, w: "TIME", p: ["t", "aɪ", "m"] }, { i: 47, w: "HALL", p: ["h", "ɔ", "l"] }, { i: 48, w: "MOOD", p: ["m", "u", "d"] }, { i: 49, w: "DOG", p: ["d", "ɔ", "g"] }, { i: 50, w: "SHOULD", p: ["ʃ", "ʊ", "d"] }
        ];

        // --- HELPER: GET LIST DATA ---
        const getListData = (listId) => {
            switch(listId) {
                case '1A': return LIST_1A;
                case '2A': return LIST_2A;
                case '3A': return LIST_3A;
                case '4A': return LIST_4A;
                default: return LIST_1A;
            }
        };

        const calculateStats = (listId, section, scores, limitTo10 = false) => {
            const allWords = getListData(listId);
            let visibleWords = allWords;

            // Section Logic
            if (section === 'first') visibleWords = allWords.slice(0, 25);
            else if (section === 'first_10') visibleWords = allWords.slice(0, 10);
            else if (section === 'second') visibleWords = allWords.slice(25, 50);
            else if (section === 'second_10') visibleWords = allWords.slice(25, 35);
            else if (section === 'full') visibleWords = allWords;

            // Apply 10-word limit if requested
            if (limitTo10) {
                visibleWords = visibleWords.slice(0, 10);
            }

            let totalPhonemes = 0;
            let correctPhonemes = 0;
            let correctWords = 0;
            let totalWords = visibleWords.length;

            visibleWords.forEach(word => {
                let wordCorrectCount = 0;
                let wordPhonemeCount = 0;
                word.p.forEach((phoneme, pIndex) => {
                    if (phoneme === '-') return;
                    wordPhonemeCount++;
                    totalPhonemes++;
                    const key = `${listId}_${word.i}_${pIndex}`;
                    if (scores[key]) {
                        correctPhonemes++;
                        wordCorrectCount++;
                    }
                });
                if (wordCorrectCount === wordPhonemeCount && wordPhonemeCount > 0) {
                    correctWords++;
                }
            });

            return {
                totalPhonemes,
                correctPhonemes,
                phonemePercent: totalPhonemes === 0 ? 0 : Math.round((correctPhonemes / totalPhonemes) * 100),
                correctWords,
                totalWords,
                wordPercent: totalWords === 0 ? 0 : Math.round((correctWords / totalWords) * 100),
                visibleWords
            };
        };

        // --- STATISTICAL SIGNIFICANCE (Thornton & Raffin, 1978) ---
        const getTheta = (x, n) => {
            return Math.asin(Math.sqrt(x / (n + 1))) + Math.asin(Math.sqrt((x + 1) / (n + 1)));
        };

        const getCriticalLimits = (scorePercent, n, confidence) => {
            const x = Math.round((scorePercent / 100) * n);
            const theta = getTheta(x, n);
            let variance;
            // Slightly adjusted variance logic for small N based on binomial approximation or keep generalized
            if (n >= 50) {
                variance = 1 / (n + 0.5);
            } else {
                variance = 1 / (n + 1);
            }
            const seDiff = Math.sqrt(2 * variance);
            const z = confidence === 95 ? 1.96 : 1.2816;

            const lowerTheta = theta - (z * seDiff);
            const upperTheta = theta + (z * seDiff);

            let lowerLimit = 0;
            let upperLimit = 100;

            for (let i = 0; i <= n; i++) {
                if (getTheta(i, n) >= lowerTheta) {
                    lowerLimit = Math.round((i/n)*100);
                    break;
                }
            }
            for (let i = n; i >= 0; i--) {
                if (getTheta(i, n) <= upperTheta) {
                    upperLimit = Math.round((i/n)*100);
                    break;
                }
            }
            return { lower: lowerLimit, upper: upperLimit };
        };

        // --- COMPONENTS ---

        // Diagnostics Panel (Automated Error Analysis)
        const DiagnosticsPanel = ({ stats, scores, listId }) => {
            const breakdown = useMemo(() => {
                const groups = {
                    "High Frequency (Fricatives, Affricates, Stops)": { total: 0, missed: 0, types: ["Fricative", "Affricate", "Stop"] },
                    "Low Frequency (Nasals, Liquids, Glides, Vowels)": { total: 0, missed: 0, types: ["Nasal", "Liquid", "Glide", "Vowel"] }
                };

                // Detailed counters for each specific type
                const details = {
                    Fricative: { total: 0, missed: 0 },
                    Affricate: { total: 0, missed: 0 },
                    Stop: { total: 0, missed: 0 },
                    Nasal: { total: 0, missed: 0 },
                    Liquid: { total: 0, missed: 0 },
                    Glide: { total: 0, missed: 0 },
                    Vowel: { total: 0, missed: 0 }
                };

                stats.visibleWords.forEach(word => {
                    word.p.forEach((p, idx) => {
                        if (p === '-') return;
                        const type = PHONEME_MAP[p]; // Get type from IPA map
                        const isCorrect = scores[`${listId}_${word.i}_${idx}`];

                        if (type) {
                            // Update Detailed Counters
                            if(details[type]) {
                                details[type].total++;
                                if (!isCorrect) details[type].missed++;
                            }

                            // Update High/Low Group Counters
                            if (groups["High Frequency (Fricatives, Affricates, Stops)"].types.includes(type)) {
                                groups["High Frequency (Fricatives, Affricates, Stops)"].total++;
                                if (!isCorrect) groups["High Frequency (Fricatives, Affricates, Stops)"].missed++;
                            } else if (groups["Low Frequency (Nasals, Liquids, Glides, Vowels)"].types.includes(type)) {
                                groups["Low Frequency (Nasals, Liquids, Glides, Vowels)"].total++;
                                if (!isCorrect) groups["Low Frequency (Nasals, Liquids, Glides, Vowels)"].missed++;
                            }
                        }
                    });
                });

                return { groups, details };
            }, [stats, scores, listId]);

            return (
                <div className="bg-slate-50 border-t border-slate-200 p-4">
                    <h4 className="text-sm font-bold text-slate-700 mb-3 flex items-center gap-2">
                        <Activity className="w-4 h-4 text-blue-600" /> Automated Error Pattern Analysis
                    </h4>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {/* High vs Low Frequency Summary */}
                        <div className="space-y-3">
                            {Object.entries(breakdown.groups).map(([name, data]) => {
                                const percent = data.total > 0 ? Math.round((data.missed / data.total) * 100) : 0;
                                return (
                                    <div key={name} className="bg-white p-3 rounded-lg border border-slate-200 shadow-sm">
                                        <div className="flex justify-between items-center mb-1">
                                            <span className="text-xs font-bold text-slate-600 uppercase tracking-wide">{name}</span>
                                            <span className={`text-xs font-bold ${percent > 30 ? 'text-red-600' : 'text-slate-500'}`}>{percent}% Missed</span>
                                        </div>
                                        <div className="w-full bg-slate-100 rounded-full h-2 mb-1">
                                            <div className={`h-2 rounded-full ${percent > 50 ? 'bg-red-500' : 'bg-blue-500'}`} style={{ width: `${percent}%` }}></div>
                                        </div>
                                        <div className="text-[10px] text-slate-400 text-right">{data.missed} / {data.total} phonemes</div>
                                    </div>
                                );
                            })}
                        </div>

                        {/* Detailed Type Breakdown */}
                        <div className="bg-white p-3 rounded-lg border border-slate-200 shadow-sm">
                            <h5 className="text-xs font-bold text-slate-500 uppercase tracking-wide mb-3 border-b border-slate-100 pb-2">Detailed Breakdown</h5>
                            <div className="grid grid-cols-2 gap-y-2 gap-x-4">
                                {Object.entries(breakdown.details).map(([type, data]) => {
                                    if(data.total === 0) return null; // Hide categories not present in list
                                    const pct = Math.round((data.missed / data.total) * 100);
                                    return (
                                        <div key={type} className="flex justify-between items-center text-xs">
                                            <span className="text-slate-600">{type}</span>
                                            <span className={`font-mono ${pct > 0 ? 'text-red-600 font-bold' : 'text-slate-400'}`}>
                                                {data.missed}/{data.total} ({pct}%)
                                            </span>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const CriticalDifferenceModal = ({ isOpen, onClose, confidenceLevel }) => {
            const chartRef = useRef(null);
            const canvasRef = useRef(null);

            useEffect(() => {
                if (!isOpen || !canvasRef.current) return;

                const zScore = confidenceLevel === 95 ? 1.96 : 1.2816;
                const ctx = canvasRef.current.getContext('2d');

                // Destroy old chart if exists
                if (chartRef.current) {
                    chartRef.current.destroy();
                }

                // Generate datasets
                const data10 = generateData(10, zScore);
                const data25 = generateData(25, zScore);
                const data30 = generateData(30, zScore);
                const data50 = generateData(50, zScore);
                const data75 = generateData(75, zScore);
                const data150 = generateData(150, zScore);

                chartRef.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [
                            // Word datasets (Dashed)
                            {
                                label: 'N = 10 (Words)',
                                data: data10,
                                borderColor: '#9467bd', // Purple
                                borderDash: [5, 5],
                                borderWidth: 2,
                                pointRadius: 0,
                                fill: false,
                                tension: 0.4
                            },
                            {
                                label: 'N = 25 (Words)',
                                data: data25,
                                borderColor: '#d62728', // Red
                                borderDash: [5, 5],
                                borderWidth: 2,
                                pointRadius: 0,
                                fill: false,
                                tension: 0.4
                            },
                            {
                                label: 'N = 50 (Words)',
                                data: data50,
                                borderColor: '#ff7f0e', // Orange
                                borderDash: [5, 5],
                                borderWidth: 2,
                                pointRadius: 0,
                                fill: false,
                                tension: 0.4
                            },
                             // Phoneme datasets (Solid)
                             {
                                label: 'N = 30 (Phonemes)',
                                data: data30,
                                borderColor: '#17becf', // Teal
                                borderWidth: 2,
                                pointRadius: 0,
                                fill: false,
                                tension: 0.4
                            },
                             {
                                label: 'N = 75 (Phonemes)',
                                data: data75,
                                borderColor: '#2ca02c', // Green
                                borderWidth: 2,
                                pointRadius: 0,
                                fill: false,
                                tension: 0.4
                            },
                            {
                                label: 'N = 150 (Phonemes)',
                                data: data150,
                                borderColor: '#1f77b4', // Blue
                                borderWidth: 2,
                                pointRadius: 0,
                                fill: false,
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            title: { display: true, text: `Critical Difference Ranges (${confidenceLevel}% Confidence)` },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ±' + context.parsed.y.toFixed(1) + '%';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                type: 'linear',
                                title: { display: true, text: 'Score (%)' },
                                min: 0,
                                max: 100
                            },
                            y: {
                                title: { display: true, text: 'Margin of Error (+/- %)' },
                                min: 0,
                                suggestedMax: 30
                            }
                        }
                    }
                });

                return () => {
                    if (chartRef.current) chartRef.current.destroy();
                };
            }, [isOpen, confidenceLevel]);

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-lg w-full max-w-4xl p-6 relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600">
                            <X className="w-6 h-6" />
                        </button>
                        <div className="h-[500px] w-full">
                            <canvas ref={canvasRef}></canvas>
                        </div>
                         <div className="mt-4 text-center">
                            <button onClick={onClose} className="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-medium">Close</button>
                        </div>
                    </div>
                </div>
            );
        };


        // --- Listening Effort Scale Component (Modal) ---
        const ListeningEffortScaleModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;

            const downloadScale = async () => {
                const element = document.getElementById('scale-capture-target');
                if (!element) return;
                try {
                    const canvas = await html2canvas(element, { backgroundColor: '#ffffff', scale: 2 });
                    const data = canvas.toDataURL('image/png');
                    const link = document.createElement('a');
                    link.href = data;
                    link.download = 'listening-effort-scale.png';
                    link.click();
                } catch (error) {
                    console.error("Download failed:", error);
                    alert("Could not export PNG. Try printing instead.");
                }
            };

            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                    {/* Added max-h and overflow for safety, reduced padding */}
                    <div className="bg-white rounded-xl shadow-lg max-w-lg w-full p-4 relative max-h-[90vh] overflow-y-auto">
                        <button onClick={onClose} className="absolute top-3 right-3 text-slate-400 hover:text-slate-600 no-print">
                            <X className="w-5 h-5" />
                        </button>

                        <div id="scale-capture-target" className="p-2 bg-white">
                            {/* Reduced margin-bottom */}
                            <h3 className="text-lg font-bold text-slate-800 mb-3 text-center">Listening Effort Scale</h3>
                            {/* Reduced space-y */}
                            <div className="space-y-1">
                                {[
                                    { val: 0, label: "No Effort", color: "bg-emerald-100 border-emerald-300 text-emerald-800" },
                                    { val: 1, label: "Very Little Effort", color: "bg-emerald-50 border-emerald-200 text-emerald-700" },
                                    { val: 2, label: "Little Effort", color: "bg-green-50 border-green-200 text-green-700" },
                                    { val: 3, label: "Moderate Effort", color: "bg-lime-50 border-lime-200 text-lime-700" },
                                    { val: 4, label: "Considerable Effort", color: "bg-yellow-50 border-yellow-200 text-yellow-700" },
                                    { val: 5, label: "Much Effort", color: "bg-amber-50 border-amber-200 text-amber-700" },
                                    { val: 6, label: "Very Much Effort", color: "bg-orange-50 border-orange-200 text-orange-700" },
                                    { val: 7, label: "Extreme Effort", color: "bg-red-50 border-red-200 text-red-700" },
                                    { val: 8, label: "Maximum Effort", color: "bg-red-100 border-red-300 text-red-800" },
                                    { val: 9, label: "Giving Up", color: "bg-rose-100 border-rose-300 text-rose-800" },
                                    { val: 10, label: "Unable to Ignore Noise", color: "bg-slate-800 border-slate-900 text-white" },
                                ].map((item) => (
                                    // Reduced padding, smaller text if needed, reduced gap
                                    <div key={item.val} className={`flex items-center gap-3 p-1.5 rounded border ${item.color}`}>
                                        <span className="font-bold text-base w-6 text-center">{item.val}</span>
                                        <span className="font-medium text-sm">{item.label}</span>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="mt-4 text-center flex gap-2 justify-center no-print">
                            <button onClick={downloadScale} className="px-4 py-1.5 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg text-sm font-medium flex items-center gap-1"><Download className="w-4 h-4"/> PNG</button>
                            <button onClick={onClose} className="px-4 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-sm font-medium">Close</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- NEW: Phoneme Disclaimer Modal ---
        const PhonemeDisclaimerModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-lg max-w-sm w-full p-6 relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600">
                            <X className="w-5 h-5" />
                        </button>
                        <div className="flex flex-col items-center text-center">
                            <div className="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mb-4 text-blue-600">
                                <AlertCircle className="w-6 h-6" />
                            </div>
                            <h3 className="text-lg font-bold text-slate-800 mb-2">Phoneme Scoring Note</h3>
                            <p className="text-sm text-slate-600 mb-6 leading-relaxed">
                                Phoneme scores are typically about <strong>20% better</strong> than whole word scores. You may want to use a <strong>lower (more difficult) SNR</strong> to avoid ceiling effects.
                            </p>
                            <button onClick={onClose} className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium w-full transition-colors">
                                Got it
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const LoadTestModal = ({ isOpen, onClose, onLoad }) => {
            const [tests, setTestsList] = useState([]);
            const [loading, setLoading] = useState(true);
            const [search, setSearch] = useState("");

            useEffect(() => {
                if(!isOpen) return;
                setLoading(true);
                localDB.getAllTests().then(data => {
                    setTestsList(data);
                    setLoading(false);
                }).catch(err => {
                    console.error("Error fetching local tests:", err);
                    setLoading(false);
                });
            }, [isOpen]);

            const handleDelete = async (testId, e) => {
                e.stopPropagation();
                if(confirm("Are you sure you want to delete this test? This cannot be undone.")) {
                    try {
                        await localDB.deleteTest(testId);
                        // Refresh list
                        const updated = await localDB.getAllTests();
                        setTestsList(updated);
                    } catch(err) { console.error("Error deleting:", err); alert("Delete failed"); }
                }
            };

            const filtered = tests.filter(t =>
                (t.patientName || "").toLowerCase().includes(search.toLowerCase()) ||
                (t.cNumber || "").toLowerCase().includes(search.toLowerCase())
            );

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-lg w-full max-w-2xl p-6 relative flex flex-col max-h-[80vh]">
                        <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><X className="w-6 h-6" /></button>
                        <h3 className="text-xl font-bold text-slate-800 mb-4">Load Patient History (Local)</h3>

                        <div className="relative mb-4">
                            <Search className="absolute left-3 top-2.5 text-slate-400 w-5 h-5" />
                            <input type="text" value={search} onChange={(e) => setSearch(e.target.value)} placeholder="Search by Name or ID..." className="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
                        </div>

                        <div className="flex-1 overflow-y-auto space-y-2 pr-2">
                            {loading ? <div className="text-center py-8 text-slate-500"><Loader className="w-8 h-8 mx-auto mb-2 text-blue-600"/>Loading records...</div> :
                             filtered.length === 0 ? <div className="text-center py-8 text-slate-500 italic">No matching records found in local database.</div> :
                             filtered.map(test => (
                                <div key={test.id} onClick={() => { onLoad(test); onClose(); }} className="p-3 border border-slate-200 rounded-lg hover:bg-slate-50 hover:border-blue-300 cursor-pointer transition group flex justify-between items-center">
                                    <div>
                                        <div className="font-bold text-slate-800">{test.patientName} <span className="text-slate-400 font-normal">#{test.cNumber}</span></div>
                                        <div className="text-xs text-slate-500">{test.testDate} • {test.tests.A.condition} vs {test.tests.B.condition}</div>
                                    </div>
                                    <button onClick={(e) => handleDelete(test.id, e)} className="p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-full transition opacity-0 group-hover:opacity-100"><Trash2 className="w-4 h-4" /></button>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- PATIENT HISTORY CHART ---
        const HistoryChart = ({ cNumber }) => {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);
            const [historyData, setHistoryData] = useState([]);
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                if (!cNumber) return;
                setLoading(true);
                localDB.getPatientHistory(cNumber).then(data => {
                    setHistoryData(data);
                    setLoading(false);
                });
            }, [cNumber]);

            useEffect(() => {
                if (!canvasRef.current || historyData.length === 0) return;

                const ctx = canvasRef.current.getContext('2d');
                if (chartRef.current) chartRef.current.destroy();

                const labels = historyData.map(t => t.testDate);

                // Helper to get stats object from saved test
                const getStats = (testObj) => {
                     return calculateStats(testObj.listId, testObj.section, testObj.scores, testObj.limitTo10);
                };

                // Prepare Data Arrays
                const wrsA = historyData.map(r => getStats(r.tests.A).wordPercent);
                const prsA = historyData.map(r => getStats(r.tests.A).phonemePercent);

                const wrsB = historyData.map(r => getStats(r.tests.B).wordPercent);
                const prsB = historyData.map(r => getStats(r.tests.B).phonemePercent);

                chartRef.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Test A Word',
                                data: wrsA,
                                borderColor: '#2563eb', // Blue-600 (Solid)
                                backgroundColor: '#2563eb',
                                tension: 0.1,
                                pointStyle: 'circle'
                            },
                            {
                                label: 'Test A Phoneme',
                                data: prsA,
                                borderColor: '#60a5fa', // Blue-400 (Lighter)
                                backgroundColor: '#60a5fa',
                                borderDash: [5, 5], // Dashed
                                tension: 0.1,
                                pointStyle: 'rectRot',
                                pointRadius: 4
                            },
                            {
                                label: 'Test B Word',
                                data: wrsB,
                                borderColor: '#9333ea', // Purple-600 (Solid)
                                backgroundColor: '#9333ea',
                                tension: 0.1,
                                pointStyle: 'circle'
                            },
                            {
                                label: 'Test B Phoneme',
                                data: prsB,
                                borderColor: '#c084fc', // Purple-400 (Lighter)
                                backgroundColor: '#c084fc',
                                borderDash: [5, 5], // Dashed
                                tension: 0.1,
                                pointStyle: 'rectRot',
                                pointRadius: 4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, max: 100, title: { display: true, text: 'Score (%)' } }
                        },
                        plugins: {
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        }
                    }
                });

                return () => { if (chartRef.current) chartRef.current.destroy(); };
            }, [historyData]);

            if (!cNumber) return <div className="text-center text-slate-400 py-10">Enter Patient ID to view history.</div>;
            if (loading) return <div className="text-center text-slate-500 py-10"><Loader className="w-8 h-8 mx-auto mb-2 text-blue-600"/>Loading history...</div>;
            if (historyData.length === 0) return <div className="text-center text-slate-400 py-10">No history found for ID: {cNumber}</div>;

            return (
                <div className="space-y-6">
                    <div className="bg-white p-4 rounded-lg border border-slate-200 h-[300px]">
                        <canvas ref={canvasRef}></canvas>
                    </div>
                    <div className="bg-white rounded-lg border border-slate-200 overflow-hidden">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-slate-50 text-slate-500 font-semibold border-b border-slate-200">
                                <tr>
                                    <th className="px-4 py-2">Date</th>
                                    <th className="px-4 py-2">Test A</th>
                                    <th className="px-4 py-2">Word A</th>
                                    <th className="px-4 py-2 text-blue-400">Phon A</th>
                                    <th className="px-4 py-2 border-l border-slate-100">Test B</th>
                                    <th className="px-4 py-2">Word B</th>
                                    <th className="px-4 py-2 text-purple-400">Phon B</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {historyData.map((record, idx) => {
                                    const statsA = calculateStats(record.tests.A.listId, record.tests.A.section, record.tests.A.scores, record.tests.A.limitTo10);
                                    const statsB = calculateStats(record.tests.B.listId, record.tests.B.section, record.tests.B.scores, record.tests.B.limitTo10);
                                    return (
                                        <tr key={record.id || idx} className="hover:bg-slate-50">
                                            <td className="px-4 py-2">{record.testDate}</td>
                                            <td className="px-4 py-2 text-slate-600">{record.tests.A.condition}</td>
                                            <td className="px-4 py-2 font-bold text-blue-600">{statsA.wordPercent}%</td>
                                            <td className="px-4 py-2 font-medium text-blue-400">{statsA.phonemePercent}%</td>

                                            <td className="px-4 py-2 text-slate-600 border-l border-slate-100">{record.tests.B.condition}</td>
                                            <td className="px-4 py-2 font-bold text-purple-600">{statsB.wordPercent}%</td>
                                            <td className="px-4 py-2 font-medium text-purple-400">{statsB.phonemePercent}%</td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [patientName, setPatientName] = useState('');
            const [cNumber, setCNumber] = useState('');
            const [testDate, setTestDate] = useState(new Date().toISOString().split('T')[0]);
            const [activeTab, setActiveTab] = useState('scoring');
            const [activeTestId, setActiveTestId] = useState('A');
            const [confidenceLevel, setConfidenceLevel] = useState(80); // DEFAULT CHANGED TO 80%
            const [clearConfirm, setClearConfirm] = useState(false);
            const [showScaleModal, setShowScaleModal] = useState(false);
            const [showChartModal, setShowChartModal] = useState(false);
            const [showPhonemeModal, setShowPhonemeModal] = useState(false); // New State
            const [showLoadModal, setShowLoadModal] = useState(false);
            const [currentTestId, setCurrentTestId] = useState(null); // Track loaded test ID

            const [tests, setTests] = useState({
                A: {
                    id: 'A',
                    listId: '3A',
                    section: 'second_10',
                    scoringMode: 'word', // Updated Default
                    condition: 'Unaided',
                    deviceModel: '',
                    level: '',
                    snr: '',
                    effort: 5,
                    scores: {},
                    limitTo10: false,
                    askedContinue: false
                },
                B: {
                    id: 'B',
                    listId: '4A',
                    section: 'second_10',
                    scoringMode: 'word', // Updated Default
                    condition: 'New Tech',
                    deviceModel: '',
                    level: '',
                    snr: '',
                    effort: 5,
                    scores: {},
                    limitTo10: false,
                    askedContinue: false
                }
            });

            const activeTest = tests[activeTestId];
            const statsA = useMemo(() => calculateStats(tests.A.listId, tests.A.section, tests.A.scores, tests.A.limitTo10), [tests.A]);
            const statsB = useMemo(() => calculateStats(tests.B.listId, tests.B.section, tests.B.scores, tests.B.limitTo10), [tests.B]);
            const activeStats = activeTestId === 'A' ? statsA : statsB;

            const wordCriticalLimits = useMemo(() => {
                if (statsA.totalWords === 0) return { lower: 0, upper: 100 };
                return getCriticalLimits(statsA.wordPercent, statsA.totalWords, confidenceLevel);
            }, [statsA.wordPercent, statsA.totalWords, confidenceLevel]);

            const phonemeCriticalLimits = useMemo(() => {
                if (statsA.totalPhonemes === 0) return { lower: 0, upper: 100 };
                return getCriticalLimits(statsA.phonemePercent, statsA.totalPhonemes, confidenceLevel);
            }, [statsA.phonemePercent, statsA.totalPhonemes, confidenceLevel]);

            const isWordDiffSig = statsB.wordPercent < wordCriticalLimits.lower || statsB.wordPercent > wordCriticalLimits.upper;
            const isPhonemeDiffSig = statsB.phonemePercent < phonemeCriticalLimits.lower || statsB.phonemePercent > phonemeCriticalLimits.upper;

            const getSectionOptions = (testId) => {
                const options = [
                    { val: 'first_10', label: '1st Half (First 10)', n: 10 },
                    { val: 'first', label: '1st Half (1-25)', n: 25 },
                    { val: 'second_10', label: '2nd Half (First 10)', n: 10 },
                    { val: 'second', label: '2nd Half (26-50)', n: 25 },
                    { val: 'full', label: 'Full List (1-50)', n: 50 }
                ];

                if (testId === 'A') return options;

                // For Test B, filter based on Test A selection
                const aSection = tests.A.section;
                const aIsTen = aSection.includes('_10');
                const aIsHalf = aSection === 'first' || aSection === 'second';
                const aIsFull = aSection === 'full';

                return options.filter(opt => {
                    if (aIsTen) return opt.n === 10;
                    if (aIsHalf) return opt.n === 25;
                    if (aIsFull) return opt.n === 50;
                    return true;
                });
            };

            const updateActiveTest = (field, value) => {

                // Trigger Phoneme Disclaimer
                if (field === 'scoringMode' && value === 'phoneme') {
                    setShowPhonemeModal(true);
                }

                setTests(prev => {
                    const newTests = {
                        ...prev,
                        [activeTestId]: {
                            ...prev[activeTestId],
                            [field]: value
                        }
                    };

                    // Logic to enforce matching sections for comparison
                    if (activeTestId === 'A' && field === 'section') {
                        // If A changes, B must match the TYPE (length)
                        const isTen = value.includes('_10');
                        const isHalf = value === 'first' || value === 'second';
                        const isFull = value === 'full';

                        let bSection = newTests.B.section;

                        // If B is currently incompatible, force it to a compatible default
                        if (isTen) {
                            if (!bSection.includes('_10')) bSection = 'first_10';
                        } else if (isHalf) {
                            if (bSection !== 'first' && bSection !== 'second') bSection = 'first';
                        } else if (isFull) {
                            bSection = 'full';
                        }
                        newTests.B.section = bSection;
                    }

                    // Enforce matching Scoring Mode across both tests
                    if (field === 'scoringMode') {
                        newTests.A.scoringMode = value;
                        newTests.B.scoringMode = value;
                    }

                    // Sync SPL and SNR from Test A to Test B
                    if (activeTestId === 'A' && (field === 'level' || field === 'snr')) {
                        newTests.B[field] = value;
                    }

                    return newTests;
                });
            };

            const togglePhoneme = (wordIndex, pIndex) => {
                const listId = activeTest.listId;
                const key = `${listId}_${wordIndex}_${pIndex}`;
                setTests(prev => {
                    const currentScores = prev[activeTestId].scores;
                    const newScores = { ...currentScores, [key]: !currentScores[key] };
                    return { ...prev, [activeTestId]: { ...prev[activeTestId], scores: newScores } };
                });
            };

            const setWordScore = (wordIndex, isCorrect) => {
                const listId = activeTest.listId;
                const wordData = activeStats.visibleWords.find(w => w.i === wordIndex);
                if (!wordData) return;

                setTests(prev => {
                    const currentScores = { ...prev[activeTestId].scores };

                    // Check if we are toggling off the current state
                    let allMatch = true;
                    // For Word Mode, we can check the first phoneme to infer word state, or check all.
                    // But effectively, if we click "Correct" and it's already fully correct, we want to clear it.
                    // If we click "Incorrect" and it's already incorrect (which usually means at least one false/undefined, but in word mode usually we set all to false),
                    // wait, in setWordScore below: isCorrect=false sets "delete keys" in previous logic, wait no.
                    // In previous implementation:
                    // isCorrect=true -> all phonemes = true
                    // isCorrect=false -> all phonemes = undefined (deleted) ??? No, false usually means WRONG.
                    // Let's redefine:
                    // Correct Button -> All Phonemes TRUE
                    // Incorrect Button -> All Phonemes FALSE (explicitly wrong)
                    // Unscored -> All Phonemes undefined.

                    // Let's check current state:
                    let currentIsAllCorrect = true;
                    let currentIsAllIncorrect = true;
                    let hasAnyScore = false;

                    wordData.p.forEach((p, idx) => {
                        if (p !== '-') {
                            const val = currentScores[`${listId}_${wordIndex}_${idx}`];
                            if (val !== undefined) hasAnyScore = true;
                            if (val !== true) currentIsAllCorrect = false;
                            if (val !== false) currentIsAllIncorrect = false;
                        }
                    });

                    // Logic:
                    // If user clicked Correct (isCorrect=true) AND currently it is All Correct -> Clear (Unscore)
                    // If user clicked Incorrect (isCorrect=false) AND currently it is All Incorrect -> Clear (Unscore)
                    // Otherwise -> Set to isCorrect value.

                    let shouldClear = false;
                    if (isCorrect && currentIsAllCorrect && hasAnyScore) shouldClear = true;
                    if (!isCorrect && currentIsAllIncorrect && hasAnyScore) shouldClear = true;

                    wordData.p.forEach((p, idx) => {
                        if (p !== '-') {
                            if (shouldClear) {
                                delete currentScores[`${listId}_${wordIndex}_${idx}`];
                            } else {
                                currentScores[`${listId}_${wordIndex}_${idx}`] = isCorrect;
                            }
                        }
                    });
                    return { ...prev, [activeTestId]: { ...prev[activeTestId], scores: currentScores } };
                });
            };

            const toggleWordCorrect = (wordIndex) => {
                // Used for Phoneme Mode green check button
                const listId = activeTest.listId;
                const wordData = activeStats.visibleWords.find(w => w.i === wordIndex);
                if (!wordData) return;

                setTests(prev => {
                    const currentScores = { ...prev[activeTestId].scores };

                    // Check if currently fully correct
                    let isFullyCorrect = true;
                    wordData.p.forEach((p, idx) => {
                        if (p !== '-' && !currentScores[`${listId}_${wordIndex}_${idx}`]) {
                            isFullyCorrect = false;
                        }
                    });

                    // Toggle logic: If fully correct, clear it. Else, mark all correct.
                    wordData.p.forEach((p, idx) => {
                        if (p !== '-') {
                            if (isFullyCorrect) {
                                delete currentScores[`${listId}_${wordIndex}_${idx}`]; // or set to false? usually clear is safer for 'toggle off'
                            } else {
                                currentScores[`${listId}_${wordIndex}_${idx}`] = true;
                            }
                        }
                    });

                    return { ...prev, [activeTestId]: { ...prev[activeTestId], scores: currentScores } };
                });
            };

            const markAll = (correct) => {
                const listData = activeStats.visibleWords;
                const listId = activeTest.listId;
                setTests(prev => {
                    const newScores = { ...prev[activeTestId].scores };
                    listData.forEach(word => {
                        word.p.forEach((phoneme, pIndex) => {
                            if (phoneme === '-') return;
                            const key = `${listId}_${word.i}_${pIndex}`;
                            if(correct) newScores[key] = true;
                            else delete newScores[key];
                        });
                    });
                    // Mark All counts as interaction, prevent prompting if we fill everything immediately
                    return { ...prev, [activeTestId]: { ...prev[activeTestId], scores: newScores, askedContinue: true } };
                });
            };

            const handleSave = async () => {
                if (!patientName.trim()) { alert("Please enter a Patient Name."); return; }
                const data = {
                    id: currentTestId, // Pass current ID if available for update
                    patientName, cNumber, testDate, tests, activeTestId, activeTab, confidenceLevel
                };
                try {
                    const savedId = await localDB.saveTest(data);
                    setCurrentTestId(savedId);
                    alert("Test saved to Local Database successfully!");
                } catch(e) {
                    console.error("Save error", e); alert("Failed to save to local database.");
                }
            };

            const handleLoadTest = (loadedData) => {
                if (loadedData) {
                    setCurrentTestId(loadedData.id);
                    setPatientName(loadedData.patientName || '');
                    setCNumber(loadedData.cNumber || '');
                    setTestDate(loadedData.testDate || new Date().toISOString().split('T')[0]);
                    setTests(loadedData.tests);
                    setActiveTestId(loadedData.activeTestId || 'A');
                    setActiveTab(loadedData.activeTab || 'scoring');
                    if(loadedData.confidenceLevel) setConfidenceLevel(loadedData.confidenceLevel);
                }
            };

            const handleDeleteCurrentRecord = async () => {
                if (!currentTestId) return;
                if (confirm("Are you sure you want to delete this record from the database?")) {
                    try {
                        await localDB.deleteTest(currentTestId);
                        alert("Record deleted.");
                        clearAllData(); // Reset UI since the record is gone
                    } catch (e) {
                        console.error(e);
                        alert("Failed to delete record.");
                    }
                }
            };

            const handleExportDB = async () => {
                try {
                    const allData = await localDB.getAllTests();
                    const jsonString = JSON.stringify(allData, null, 2);
                    const blob = new Blob([jsonString], { type: "application/json" });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `NU6_Full_Database_Export_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } catch (err) {
                    console.error("Export failed:", err);
                    alert("Failed to export database.");
                }
            };

            const clearAllData = () => {
                if (clearConfirm) {
                    setCurrentTestId(null);
                    setPatientName('');
                    setCNumber('');
                    setTestDate(new Date().toISOString().split('T')[0]);
                    setTests({
                        A: { id: 'A', listId: '3A', section: 'second_10', scoringMode: 'word', condition: 'Unaided', deviceModel: '', level: '', snr: '', effort: 5, scores: {}, limitTo10: false, askedContinue: false },
                        B: { id: 'B', listId: '4A', section: 'second_10', scoringMode: 'word', condition: 'New Tech', deviceModel: '', level: '', snr: '', effort: 5, scores: {}, limitTo10: false, askedContinue: false }
                    });
                    setActiveTestId('A');
                    setActiveTab('scoring');
                    setClearConfirm(false);
                } else {
                    setClearConfirm(true);
                    setTimeout(() => setClearConfirm(false), 3000);
                }
            };

            const getEffortColor = (val) => { if (val <= 4) return 'text-emerald-600'; if (val >= 6) return 'text-red-600'; return 'text-blue-600'; };

            const effortDelta = tests.B.effort - tests.A.effort;

            return (
                <div className="min-h-screen bg-slate-100 p-4 md:p-8 print:p-0 print:bg-white">
                    <ListeningEffortScaleModal isOpen={showScaleModal} onClose={() => setShowScaleModal(false)} />
                    <CriticalDifferenceModal isOpen={showChartModal} onClose={() => setShowChartModal(false)} confidenceLevel={confidenceLevel} />
                    <PhonemeDisclaimerModal isOpen={showPhonemeModal} onClose={() => setShowPhonemeModal(false)} />
                    <LoadTestModal isOpen={showLoadModal} onClose={() => setShowLoadModal(false)} onLoad={handleLoadTest} />

                    <div className="max-w-5xl mx-auto space-y-6">
                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 print:hidden">
                            <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                                <div>
                                    <h1 className="text-2xl font-bold text-slate-800 flex items-center gap-2">
                                        <Calculator className="w-6 h-6 text-blue-600" />
                                        NU-6 Phoneme Scorer
                                    </h1>
                                    <p className="text-slate-500 text-sm">Comparison Mode & Multi-list Support</p>
                                </div>
                                <div className="flex flex-wrap gap-2 justify-end">
                                    <button onClick={() => setShowLoadModal(true)} className="flex items-center gap-2 px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition text-sm font-medium"><Database className="w-4 h-4" /> Load Patient</button>
                                    <button onClick={handleExportDB} className="flex items-center gap-2 px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition text-sm font-medium"><Download className="w-4 h-4" /> Export DB</button>
                                    <button onClick={handleSave} className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm font-medium"><Save className="w-4 h-4" /> Save (Local)</button>
                                    {currentTestId && (
                                        <button onClick={handleDeleteCurrentRecord} className="flex items-center gap-2 px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition text-sm font-medium"><Trash2 className="w-4 h-4" /> Delete</button>
                                    )}
                                    <button onClick={clearAllData} className={`flex items-center gap-2 px-4 py-2 rounded-lg transition text-sm font-medium ${clearConfirm ? 'bg-red-600 text-white hover:bg-red-700' : 'bg-red-100 text-red-700 hover:bg-red-200'}`}><RotateCcw className="w-4 h-4" /> {clearConfirm ? "Confirm?" : "New Test"}</button>
                                </div>
                            </div>

                            {/* Patient Information Section - Full Width */}
                            <div className="bg-slate-50 p-6 rounded-xl border border-slate-200 mb-6">
                                <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4">Patient Information</h3>
                                <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                                    <div>
                                        <label className="block text-xs font-medium text-slate-500 mb-1">Patient Name</label>
                                        <input type="text" value={patientName} onChange={(e) => setPatientName(e.target.value)} className="w-full px-3 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" placeholder="Enter name..." />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-medium text-slate-500 mb-1">ID</label>
                                        <input type="text" value={cNumber} onChange={(e) => setCNumber(e.target.value)} className="w-full px-3 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" placeholder="Patient ID" />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-medium text-slate-500 mb-1">Test Date</label>
                                        <input type="date" value={testDate} onChange={(e) => setTestDate(e.target.value)} className="w-full px-3 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" />
                                    </div>
                                    <div className="flex items-end">
                                        <div className="bg-white p-3 rounded-lg text-xs text-slate-600 border border-slate-200 w-full h-[42px] flex items-center justify-center text-center leading-tight">
                                            Comparison Mode Active
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className="flex space-x-1 bg-slate-100 p-1 rounded-lg w-fit">
                                <button onClick={() => setActiveTab('scoring')} className={`px-4 py-2 text-sm font-medium rounded-md tab-btn flex items-center gap-2 ${activeTab === 'scoring' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-600 hover:text-slate-900'}`}><CheckCircle2 className="w-4 h-4" /> Scoring Entry</button>
                                <button onClick={() => setActiveTab('comparison')} className={`px-4 py-2 text-sm font-medium rounded-md tab-btn flex items-center gap-2 ${activeTab === 'comparison' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-600 hover:text-slate-900'}`}><BarChart3 className="w-4 h-4" /> Comparison Results</button>
                                <button onClick={() => setActiveTab('history')} className={`px-4 py-2 text-sm font-medium rounded-md tab-btn flex items-center gap-2 ${activeTab === 'history' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-600 hover:text-slate-900'}`}><HistoryIcon className="w-4 h-4" /> Longitudinal History</button>
                            </div>
                        </div>

                        {activeTab === 'scoring' && (
                            <div className="space-y-6">
                                <div className="grid grid-cols-2 gap-4 print:hidden">
                                    {['A', 'B'].map(id => {
                                        const t = tests[id];
                                        const s = id === 'A' ? statsA : statsB;
                                        const isActive = activeTestId === id;
                                        return (
                                            <button key={id} onClick={() => setActiveTestId(id)} className={`relative p-4 rounded-xl border-2 text-left transition-all ${isActive ? 'border-blue-500 bg-blue-50/50' : 'border-slate-200 bg-white hover:border-slate-300'}`}>
                                                <div className="flex justify-between items-start mb-2">
                                                    <span className={`px-2 py-0.5 rounded text-xs font-bold ${isActive ? 'bg-blue-600 text-white' : 'bg-slate-200 text-slate-600'}`}>TEST {id}</span>
                                                    {isActive && <span className="flex h-3 w-3 relative"><span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span><span className="relative inline-flex rounded-full h-3 w-3 bg-blue-500"></span></span>}
                                                </div>
                                                <div className="text-sm font-semibold text-slate-800">{t.condition}</div>
                                                <div className="text-xs text-slate-500 mb-2">{t.listId}
                                                    {t.section === 'first' && ' (1st Half)'}
                                                    {t.section === 'second' && ' (2nd Half)'}
                                                    {t.section === 'full' && ' (Full)'}
                                                    {t.section === 'first_10' && ' (1st Half - 10 Words)'}
                                                    {t.section === 'second_10' && ' (2nd Half - 10 Words)'}
                                                </div>
                                                <div className="flex gap-3 text-sm">
                                                    <span className="font-bold text-slate-700">W: {s.wordPercent}%</span>
                                                    {t.scoringMode === 'phoneme' && <span className="font-bold text-slate-700">P: {s.phonemePercent}%</span>}
                                                </div>
                                            </button>
                                        );
                                    })}
                                </div>

                                <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 print:hidden">
                                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">

                                        {/* Left Side: Condition & Scoring Mode (Span 5) */}
                                        <div className="lg:col-span-5 space-y-6">
                                            <div>
                                                <label className="block text-xs font-medium text-slate-500 mb-2">Condition</label>
                                                <div className="flex rounded-lg overflow-hidden border border-slate-200 mb-3">
                                                    {(activeTestId === 'A' ? ['Unaided', 'Current Tech'] : ['Current Tech', 'New Tech']).map(c => (
                                                        <button key={c} onClick={() => updateActiveTest('condition', c)} className={`flex-1 py-2 text-sm font-medium transition ${activeTest.condition === c ? 'bg-indigo-600 text-white' : 'bg-slate-50 hover:bg-slate-100 text-slate-600'}`}>{c}</button>
                                                    ))}
                                                </div>
                                                {(activeTest.condition === 'Current Tech' || activeTest.condition === 'New Tech') && (
                                                    <div><input type="text" value={activeTest.deviceModel || ''} onChange={(e) => updateActiveTest('deviceModel', e.target.value)} className="w-full px-3 py-2 rounded-lg border border-slate-300 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter Make/Model..." /></div>
                                                )}
                                            </div>

                                            <div>
                                                <label className="block text-xs font-medium text-slate-500 mb-2">Scoring Mode</label>
                                                <div className="flex rounded-lg overflow-hidden border border-slate-200">
                                                    <button onClick={() => updateActiveTest('scoringMode', 'phoneme')} className={`flex-1 py-2 text-xs font-bold flex items-center justify-center gap-1 transition ${activeTest.scoringMode === 'phoneme' ? 'bg-slate-700 text-white' : 'bg-slate-50 text-slate-600 hover:bg-slate-100'}`}><ListChecks className="w-3 h-3" /> Phoneme</button>
                                                    <button onClick={() => updateActiveTest('scoringMode', 'word')} className={`flex-1 py-2 text-xs font-bold flex items-center justify-center gap-1 transition ${activeTest.scoringMode === 'word' ? 'bg-slate-700 text-white' : 'bg-slate-50 text-slate-600 hover:bg-slate-100'}`}><WholeWord className="w-3 h-3" /> Word</button>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Right Side: List Params (Span 7) */}
                                        <div className="lg:col-span-7 grid grid-cols-2 gap-4">
                                            {/* Row 1: Word List & Section */}
                                            <div>
                                                <label className="block text-xs font-medium text-slate-500 mb-1">Word List</label>
                                                <select value={activeTest.listId} onChange={(e) => updateActiveTest('listId', e.target.value)} className="w-full px-3 py-2 rounded-lg border border-slate-300 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                    <option value="1A">List 1A</option>
                                                    <option value="2A">List 2A</option>
                                                    <option value="3A">List 3A</option>
                                                    <option value="4A">List 4A</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-xs font-medium text-slate-500 mb-1">Section</label>
                                                <select
                                                    value={activeTest.section}
                                                    onChange={(e) => updateActiveTest('section', e.target.value)}
                                                    className="w-full px-3 py-2 rounded-lg border border-slate-300 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                >
                                                    {getSectionOptions(activeTestId).map(opt => (
                                                        <option key={opt.val} value={opt.val}>{opt.label}</option>
                                                    ))}
                                                </select>
                                            </div>

                                            {/* Row 2: SPL & SNR */}
                                            <div>
                                                <label className="block text-xs font-medium text-slate-500 mb-1">SPL (dBC)</label>
                                                <input type="text" value={activeTest.level} onChange={(e) => updateActiveTest('level', e.target.value)} className="w-full px-3 py-2 rounded-lg border border-slate-300 text-sm" />
                                            </div>
                                            <div>
                                                <label className="block text-xs font-medium text-slate-500 mb-1">SNR (dB)</label>
                                                <input type="text" value={activeTest.snr} onChange={(e) => updateActiveTest('snr', e.target.value)} className="w-full px-3 py-2 rounded-lg border border-slate-300 text-sm" />
                                            </div>

                                            {/* Row 3: Listening Effort (Full width of right column) */}
                                            <div className="col-span-2 pt-2 border-t border-slate-100 mt-2">
                                                <div className="flex justify-between items-center mb-1">
                                                    <label className="block text-xs font-medium text-slate-500">Listening Effort (0-10)</label>
                                                    <button onClick={() => setShowScaleModal(true)} className="text-[10px] text-blue-600 hover:underline flex items-center gap-1"><HelpCircle className="w-3 h-3" /> View Scale</button>
                                                </div>
                                                <div className="flex gap-3 items-center">
                                                    <div className="flex-1">
                                                        <input
                                                            type="range"
                                                            min="0"
                                                            max="10"
                                                            value={activeTest.effort}
                                                            onChange={(e) => updateActiveTest('effort', parseInt(e.target.value))}
                                                            className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600 block"
                                                        />
                                                        <div className="flex justify-between text-[10px] text-slate-400 mt-1 px-1">
                                                            <span>0</span>
                                                            <span>5</span>
                                                            <span>10</span>
                                                        </div>
                                                    </div>
                                                    <span className="font-bold text-lg w-8 text-center text-slate-700 mb-3">{activeTest.effort}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {activeTest.scoringMode === 'phoneme' && (
                                    <DiagnosticsPanel stats={activeStats} scores={activeTest.scores} listId={activeTest.listId} />
                                )}

                                <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden print:shadow-none print:border-2 print:border-black">
                                    <div className="bg-slate-50 px-4 py-3 border-b border-slate-200 flex justify-between items-center print:bg-slate-200">
                                        <div className="font-bold text-slate-700 flex items-center gap-2">
                                            Scoring: Test {activeTestId} <span className="font-normal text-slate-500 mx-1">|</span> {activeTest.listId}
                                            {activeTest.limitTo10 && <span className="ml-2 px-2 py-0.5 bg-orange-100 text-orange-700 text-xs rounded-full border border-orange-200 flex items-center gap-1"><AlertCircle className="w-3 h-3"/> Limited to 10 Words</span>}
                                        </div>
                                        <div className="flex gap-2 print:hidden">
                                            {activeTest.limitTo10 && (
                                                <button onClick={() => updateActiveTest('limitTo10', false)} className="text-xs px-3 py-1 bg-blue-50 text-blue-600 border border-blue-200 rounded hover:bg-blue-100 font-medium">Continue to Full List</button>
                                            )}
                                            <button onClick={() => markAll(true)} className="text-xs px-2 py-1 bg-emerald-100 text-emerald-700 rounded hover:bg-emerald-200 font-medium">Mark All</button>
                                        </div>
                                    </div>
                                    <table className="w-full text-left text-sm">
                                        <thead className="bg-slate-50 border-b border-slate-200 text-xs uppercase text-slate-500 print:hidden">
                                            <tr>
                                                <th className="px-4 py-2 w-10">#</th>
                                                <th className="px-4 py-2">Word</th>
                                                {activeTest.scoringMode === 'phoneme' && (
                                                    <React.Fragment>
                                                        <th className="px-2 py-2 text-center">I</th>
                                                        <th className="px-2 py-2 text-center">M</th>
                                                        <th className="px-2 py-2 text-center">F</th>
                                                    </React.Fragment>
                                                )}
                                                <th className="px-4 py-2 text-center">{activeTest.scoringMode === 'phoneme' ? 'Word' : 'Result'}</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {activeStats.visibleWords.map((word) => {
                                                const listId = activeTest.listId;

                                                const phonemeScores = word.p.map((p, idx) => {
                                                    if (p === '-') return null;
                                                    return activeTest.scores[`${listId}_${word.i}_${idx}`];
                                                }).filter(val => val !== null);

                                                const isWordCorrect = phonemeScores.every(s => s === true);
                                                const isWordScored = phonemeScores.some(s => s !== undefined);
                                                const isWordIncorrect = isWordScored && !isWordCorrect;
                                                const isWordFullyIncorrect = phonemeScores.every(s => s === false); // All explicit false

                                                return (
                                                    <tr key={word.i} className="hover:bg-slate-50">
                                                        <td className="px-4 py-2 text-slate-400 font-mono text-xs">{word.i}</td>
                                                        <td className="px-4 py-2 font-bold text-slate-800">{word.w}</td>

                                                        {activeTest.scoringMode === 'phoneme' ? (
                                                            <React.Fragment>
                                                                {word.p.map((phoneme, pIndex) => {
                                                                    const isCorrect = !!activeTest.scores[`${listId}_${word.i}_${pIndex}`];
                                                                    const isPlaceholder = phoneme === '-';
                                                                    return (
                                                                        <td key={pIndex} className="px-1 py-1 text-center">
                                                                            {!isPlaceholder ? (
                                                                                <button onClick={() => togglePhoneme(word.i, pIndex)} className={`w-10 h-8 rounded flex items-center justify-center font-medium text-base border transition-colors ${isCorrect ? 'bg-emerald-50 border-emerald-200 text-emerald-700 hover:bg-emerald-100 print:border-none print:text-black print:font-bold' : 'bg-white border-slate-200 text-slate-400 hover:border-red-300 hover:text-red-500 hover:bg-red-50'}`}>
                                                                                    <span className="ipa-text">{phoneme}</span>
                                                                                </button>
                                                                            ) : <span className="text-slate-300">—</span>}
                                                                        </td>
                                                                    );
                                                                })}
                                                                <td className="px-4 py-2 text-center print:hidden">
                                                                    <div className="flex items-center justify-center gap-2">
                                                                        <button
                                                                            onClick={() => toggleWordCorrect(word.i)}
                                                                            title={isWordCorrect ? "Clear Word" : "Mark Whole Word Correct"}
                                                                            className={`w-8 h-8 rounded-full border flex items-center justify-center transition-colors ${isWordCorrect ? 'bg-emerald-100 border-emerald-300 text-emerald-700' : 'bg-slate-50 border-slate-200 text-slate-400 hover:bg-emerald-50 hover:text-emerald-500 hover:border-emerald-200'}`}
                                                                        >
                                                                            <Check className="w-4 h-4" />
                                                                        </button>
                                                                    </div>
                                                                </td>
                                                            </React.Fragment>
                                                        ) : (
                                                            <td className="px-4 py-2 text-center">
                                                                <div className="flex gap-2 justify-center">
                                                                    <button
                                                                        onClick={() => setWordScore(word.i, true)}
                                                                        className={`flex-1 max-w-[80px] py-1.5 rounded-md font-bold text-xs border transition-colors flex items-center justify-center gap-1 ${isWordCorrect ? 'bg-emerald-600 text-white border-emerald-700 shadow-sm' : 'bg-white border-slate-200 text-slate-400 hover:bg-emerald-50 hover:text-emerald-600'}`}
                                                                    >
                                                                        <Check className="w-3 h-3" /> Correct
                                                                    </button>
                                                                    <button
                                                                        onClick={() => setWordScore(word.i, false)}
                                                                        className={`flex-1 max-w-[80px] py-1.5 rounded-md font-bold text-xs border transition-colors flex items-center justify-center gap-1 ${isWordFullyIncorrect ? 'bg-red-600 text-white border-red-700 shadow-sm' : 'bg-white border-slate-200 text-slate-400 hover:bg-red-50 hover:text-red-600'}`}
                                                                    >
                                                                        <X className="w-3 h-3" /> Incorrect
                                                                    </button>
                                                                </div>
                                                            </td>
                                                        )}
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                    {activeTest.limitTo10 && (
                                        <div className="bg-slate-50 border-t border-slate-200 p-4 text-center text-xs text-slate-500 italic">
                                            Test stopped at 10 words. Words 11+ are excluded from scoring.
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {(activeTab === 'comparison' || window.matchMedia('print').matches) && (
                            <div className={`space-y-6 ${activeTab !== 'comparison' ? 'hidden print:block' : ''}`}>
                                <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden print:shadow-none print:border-2 print:border-black">
                                    <div className="bg-slate-800 text-white px-6 py-4 flex items-center justify-between print:bg-black print:text-white">
                                        <h2 className="text-lg font-bold flex items-center gap-2"><BarChart3 className="w-5 h-5" /> Score Comparison</h2>
                                        <div className="text-right">
                                            <div className="text-xs opacity-75 font-mono">{testDate} • {patientName} • #{cNumber}</div>
                                            <div className="text-[10px] opacity-50 mt-1">Thornton & Raffin (1978) Model</div>
                                        </div>
                                    </div>
                                    <div className="p-6">
                                        <div className="flex justify-end mb-4 print:hidden">
                                            <div className="bg-slate-100 p-1 rounded-lg flex items-center gap-2 text-sm">
                                                <span className="px-2 text-xs font-semibold text-slate-500 uppercase">Confidence Level</span>
                                                <button onClick={() => setConfidenceLevel(95)} className={`px-3 py-1 rounded-md transition ${confidenceLevel === 95 ? 'bg-white shadow text-blue-700 font-bold' : 'text-slate-600 hover:bg-slate-200'}`}>95%</button>
                                                <button onClick={() => setConfidenceLevel(80)} className={`px-3 py-1 rounded-md transition ${confidenceLevel === 80 ? 'bg-white shadow text-blue-700 font-bold' : 'text-slate-600 hover:bg-slate-200'}`}>80%</button>
                                                <button onClick={() => setShowChartModal(true)} className="px-3 py-1 bg-white hover:bg-slate-200 text-slate-600 rounded-md transition border border-slate-200 flex items-center gap-1"><TrendingUp className="w-3 h-3" /> View Chart</button>
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-3 gap-8 mb-8">
                                            <div className="bg-slate-50 rounded-lg p-4 border border-slate-200 print:bg-white print:border-black">
                                                <div className="text-xs font-bold text-slate-500 uppercase mb-1">Test A (Baseline)</div>
                                                <div className="text-lg font-bold text-slate-900 mb-2">
                                                    {tests.A.condition}
                                                    {tests.A.deviceModel && <span className="block text-sm font-normal text-slate-500">{tests.A.deviceModel}</span>}
                                                </div>
                                                <div className="text-sm text-slate-600 mb-4 space-y-1">
                                                    <div>List: {tests.A.listId}
                                                        {tests.A.section === 'first' && ' (1st Half)'}
                                                        {tests.A.section === 'second' && ' (2nd Half)'}
                                                        {tests.A.section === 'full' && ' (Full)'}
                                                        {tests.A.section === 'first_10' && ' (1st Half - 10 Words)'}
                                                        {tests.A.section === 'second_10' && ' (2nd Half - 10 Words)'}
                                                    </div>
                                                    <div>Level: {tests.A.level || '--'} dBC</div>
                                                    <div>SNR: {tests.A.snr || '--'} dB</div>
                                                    <div className="flex items-center gap-2 mt-1"><span className="text-xs uppercase font-bold text-slate-400">Effort:</span> <span className={`font-bold ${getEffortColor(tests.A.effort)}`}>{tests.A.effort}/10</span></div>
                                                </div>
                                                <div className="space-y-2 border-t border-slate-200 pt-3">
                                                    <div className="flex justify-between items-center"><span className="text-sm text-slate-600">Word Score</span><span className="text-xl font-bold text-blue-600">{statsA.wordPercent}%</span></div>
                                                    {tests.A.scoringMode === 'phoneme' && (
                                                        <div className="flex justify-between items-center"><span className="text-sm text-slate-600">Phoneme Score</span><span className="text-lg font-semibold text-slate-700">{statsA.phonemePercent}%</span></div>
                                                    )}
                                                </div>
                                            </div>
                                            <div className="flex flex-col items-center justify-center text-center">
                                                <div className="mb-2 text-xs font-bold text-slate-400 uppercase">Difference (B - A)</div>
                                                <div className={`text-3xl font-bold mb-1 ${statsB.wordPercent - statsA.wordPercent >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>{statsB.wordPercent - statsA.wordPercent > 0 ? '+' : ''}{statsB.wordPercent - statsA.wordPercent}%</div>
                                                <div className="text-sm text-slate-500 mb-6">Word Recognition</div>

                                                {(tests.A.scoringMode === 'phoneme' && tests.B.scoringMode === 'phoneme') ? (
                                                    <React.Fragment>
                                                        <div className={`text-2xl font-bold mb-1 ${statsB.phonemePercent - statsA.phonemePercent >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>{statsB.phonemePercent - statsA.phonemePercent > 0 ? '+' : ''}{statsB.phonemePercent - statsA.phonemePercent}%</div>
                                                        <div className="text-sm text-slate-500 mb-6">Phoneme Recognition</div>
                                                    </React.Fragment>
                                                ) : <div className="text-xs text-slate-400 italic mb-6">Phoneme diff unavailable</div>}

                                                <div className={`text-xl font-bold mb-1 ${effortDelta < 0 ? 'text-emerald-600' : effortDelta > 0 ? 'text-red-600' : 'text-slate-600'}`}>
                                                    {effortDelta > 0 ? '+' : ''}{effortDelta}
                                                </div>
                                                <div className="text-sm text-slate-500">Effort Delta</div>
                                            </div>
                                            <div className="bg-slate-50 rounded-lg p-4 border border-slate-200 print:bg-white print:border-black flex flex-col justify-between">
                                                <div>
                                                    <div className="text-xs font-bold text-slate-500 uppercase mb-1">Test B (Comparison)</div>
                                                    <div className="text-lg font-bold text-slate-900 mb-2">
                                                        {tests.B.condition}
                                                        {tests.B.deviceModel && <span className="block text-sm font-normal text-slate-500">{tests.B.deviceModel}</span>}
                                                    </div>
                                                    <div className="text-sm text-slate-600 mb-4 space-y-1">
                                                        <div>List: {tests.B.listId}
                                                            {tests.B.section === 'first' && ' (1st Half)'}
                                                            {tests.B.section === 'second' && ' (2nd Half)'}
                                                            {tests.B.section === 'full' && ' (Full)'}
                                                            {tests.B.section === 'first_10' && ' (1st Half - 10 Words)'}
                                                            {tests.B.section === 'second_10' && ' (2nd Half - 10 Words)'}
                                                        </div>
                                                        <div>Level: {tests.B.level || '--'} dBC</div>
                                                        <div>SNR: {tests.B.snr || '--'} dB</div>
                                                        <div className="flex items-center gap-2 mt-1"><span className="text-xs uppercase font-bold text-slate-400">Effort:</span> <span className={`font-bold ${getEffortColor(tests.B.effort)}`}>{tests.B.effort}/10</span></div>
                                                    </div>
                                                    <div className="space-y-2 border-t border-slate-200 pt-3">
                                                        <div className="flex justify-between items-center"><span className="text-sm text-slate-600">Word Score</span><span className="text-xl font-bold text-blue-600">{statsB.wordPercent}%</span></div>
                                                        {tests.B.scoringMode === 'phoneme' && (
                                                            <div className="flex justify-between items-center"><span className="text-sm text-slate-600">Phoneme Score</span><span className="text-lg font-semibold text-slate-700">{statsB.phonemePercent}%</span></div>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="border border-slate-200 rounded-lg overflow-hidden mb-6">
                                            <table className="w-full text-sm">
                                                <thead className="bg-slate-100 text-slate-600 font-semibold border-b border-slate-200">
                                                    <tr>
                                                        <th className="px-4 py-2 text-left">Metric (N)</th>
                                                        <th className="px-4 py-2 text-center w-24">Test A</th>
                                                        <th className="px-4 py-2 text-center w-32 bg-slate-50">Critical Range <span className="text-[10px] text-slate-400 block font-normal">({confidenceLevel}%)</span></th>
                                                        <th className="px-4 py-2 text-center w-24">Test B</th>
                                                        <th className="px-4 py-2 text-center w-32">Significant?</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-100">
                                                    <tr>
                                                        <td className="px-4 py-3 font-medium text-slate-800">Word Score <span className="block text-xs text-slate-400 font-normal">N = {statsA.totalWords}</span></td>
                                                        <td className="px-4 py-3 text-center text-slate-700 font-bold">{statsA.wordPercent}%</td>
                                                        <td className="px-4 py-3 text-center text-slate-500 bg-slate-50 text-xs font-mono">{wordCriticalLimits.lower}% - {wordCriticalLimits.upper}%</td>
                                                        <td className="px-4 py-3 text-center text-slate-700 font-bold">{statsB.wordPercent}%</td>
                                                        <td className="px-4 py-3 text-center">
                                                            {isWordDiffSig ? (
                                                                <span className="inline-flex items-center gap-1 text-emerald-600 font-bold bg-emerald-50 px-2 py-1 rounded text-xs">
                                                                    <Check className="w-3 h-3" /> Yes
                                                                </span>
                                                            ) : (
                                                                <span className="inline-flex items-center gap-1 text-red-600 font-bold bg-red-50 px-2 py-1 rounded text-xs">
                                                                    <X className="w-3 h-3" /> No
                                                                </span>
                                                            )}
                                                        </td>
                                                    </tr>
                                                    {(tests.A.scoringMode === 'phoneme' && tests.B.scoringMode === 'phoneme') && (
                                                        <tr>
                                                            <td className="px-4 py-3 font-medium text-slate-800">Phoneme Score <span className="block text-xs text-slate-400 font-normal">N = {statsA.totalPhonemes}</span></td>
                                                            <td className="px-4 py-3 text-center text-slate-700 font-bold">{statsA.phonemePercent}%</td>
                                                            <td className="px-4 py-3 text-center text-slate-500 bg-slate-50 text-xs font-mono">{phonemeCriticalLimits.lower}% - {phonemeCriticalLimits.upper}%</td>
                                                            <td className="px-4 py-3 text-center text-slate-700 font-bold">{statsB.phonemePercent}%</td>
                                                            <td className="px-4 py-3 text-center">
                                                                {isPhonemeDiffSig ? (
                                                                    <span className="inline-flex items-center gap-1 text-emerald-600 font-bold bg-emerald-50 px-2 py-1 rounded text-xs">
                                                                        <Check className="w-3 h-3" /> Yes
                                                                    </span>
                                                                ) : (
                                                                    <span className="inline-flex items-center gap-1 text-red-600 font-bold bg-red-50 px-2 py-1 rounded text-xs">
                                                                        <X className="w-3 h-3" /> No
                                                                    </span>
                                                                )}
                                                            </td>
                                                        </tr>
                                                    )}
                                                </tbody>
                                            </table>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold uppercase text-slate-500 mb-2">Clinical Interpretation / Notes</label>
                                            <textarea className="w-full border border-slate-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-blue-500 h-24" placeholder="Enter notes comparing the two conditions..."></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'history' && (
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 print:shadow-none print:border-2 print:border-black">
                                <HistoryChart cNumber={cNumber} />
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
