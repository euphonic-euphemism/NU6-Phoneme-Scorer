<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NU-6 Phoneme Scoring (Secure)</title>

    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- html2canvas for PNG Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Chart.js for Critical Difference Graph -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- jsPDF for Professional Reports -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .phoneme-btn { transition: all 0.2s; }
        .ipa-text { font-family: 'Times New Roman', serif; }
        .tab-btn { transition: all 0.2s; }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            .page-break { page-break-before: always; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <!-- STANDARD JS: Cryptography & Database Logic -->
    <script>
        // --- CRYPTOGRAPHY SERVICE ---
        const CryptoService = {
            deriveKey: async (password, salt) => {
                const enc = new TextEncoder();
                const keyMaterial = await window.crypto.subtle.importKey(
                    "raw", enc.encode(password), { name: "PBKDF2" }, false, ["deriveKey"]
                );
                return window.crypto.subtle.deriveKey(
                    { name: "PBKDF2", salt: salt, iterations: 100000, hash: "SHA-256" },
                    keyMaterial, { name: "AES-GCM", length: 256 }, false, ["encrypt", "decrypt"]
                );
            },
            encryptData: async (dataObj, password) => {
                const salt = window.crypto.getRandomValues(new Uint8Array(16));
                const iv = window.crypto.getRandomValues(new Uint8Array(12));
                const key = await CryptoService.deriveKey(password, salt);
                const enc = new TextEncoder();
                const encodedData = enc.encode(JSON.stringify(dataObj));
                const encryptedContent = await window.crypto.subtle.encrypt(
                    { name: "AES-GCM", iv: iv }, key, encodedData
                );
                return {
                    salt: btoa(String.fromCharCode(...salt)),
                    iv: btoa(String.fromCharCode(...iv)),
                    data: btoa(String.fromCharCode(...new Uint8Array(encryptedContent)))
                };
            },
            decryptData: async (encryptedObj, password) => {
                try {
                    const salt = new Uint8Array(atob(encryptedObj.salt).split("").map(c => c.charCodeAt(0)));
                    const iv = new Uint8Array(atob(encryptedObj.iv).split("").map(c => c.charCodeAt(0)));
                    const data = new Uint8Array(atob(encryptedObj.data).split("").map(c => c.charCodeAt(0)));
                    const key = await CryptoService.deriveKey(password, salt);
                    const decryptedContent = await window.crypto.subtle.decrypt(
                        { name: "AES-GCM", iv: iv }, key, data
                    );
                    const dec = new TextDecoder();
                    return JSON.parse(dec.decode(decryptedContent));
                } catch (e) {
                    throw new Error("Decryption failed.");
                }
            }
        };

        // --- LOCAL INDEXEDDB CONFIGURATION ---
        const DB_NAME = 'NU6_Audiology_DB_Secure';
        const DB_VERSION = 1;
        const STORE_NAME = 'secure_tests';
        const CONFIG_STORE = 'app_config';

        const dbPromise = new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onerror = (event) => reject("Database error: " + event.target.errorCode);
            request.onsuccess = (event) => resolve(event.target.result);
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, { keyPath: "id" });
                if (!db.objectStoreNames.contains(CONFIG_STORE)) db.createObjectStore(CONFIG_STORE, { keyPath: "id" });
            };
        });

        // --- SECURE DB INTERFACE ---
        window.SecureDB = {
            sessionPassword: null,
            isSetup: async () => {
                const db = await dbPromise;
                return new Promise((resolve) => {
                    const tx = db.transaction([CONFIG_STORE], "readonly");
                    const req = tx.objectStore(CONFIG_STORE).get("validation");
                    req.onsuccess = () => resolve(!!req.result);
                    req.onerror = () => resolve(false);
                });
            },
            setupPassword: async (password) => {
                const encryptedValidation = await CryptoService.encryptData({ check: "VALID" }, password);
                const db = await dbPromise;
                return new Promise((resolve, reject) => {
                    const tx = db.transaction([CONFIG_STORE], "readwrite");
                    tx.objectStore(CONFIG_STORE).put({ id: "validation", ...encryptedValidation });
                    tx.oncomplete = () => {
                        window.SecureDB.sessionPassword = password;
                        resolve(true);
                    };
                    tx.onerror = () => reject("Setup failed");
                });
            },
            login: async (password) => {
                const db = await dbPromise;
                return new Promise((resolve, reject) => {
                    const tx = db.transaction([CONFIG_STORE], "readonly");
                    const req = tx.objectStore(CONFIG_STORE).get("validation");
                    req.onsuccess = async () => {
                        if (!req.result) return reject("No setup found");
                        try {
                            const decrypted = await CryptoService.decryptData(req.result, password);
                            if (decrypted.check === "VALID") {
                                window.SecureDB.sessionPassword = password;
                                resolve(true);
                            } else {
                                resolve(false);
                            }
                        } catch (e) { resolve(false); }
                    };
                });
            },
            saveTest: async (data) => {
                if (!window.SecureDB.sessionPassword) throw new Error("Database locked");
                const encryptedData = await CryptoService.encryptData(data, window.SecureDB.sessionPassword);
                const recordId = data.id || Date.now().toString();
                const db = await dbPromise;
                return new Promise((resolve, reject) => {
                    const tx = db.transaction([STORE_NAME], "readwrite");
                    tx.objectStore(STORE_NAME).put({ id: String(recordId), ...encryptedData });
                    tx.oncomplete = () => resolve(recordId);
                    tx.onerror = (e) => reject(e.target.error);
                });
            },
            getAllTests: async () => {
                if (!window.SecureDB.sessionPassword) throw new Error("Database locked");
                const db = await dbPromise;
                return new Promise((resolve, reject) => {
                    const tx = db.transaction([STORE_NAME], "readonly");
                    const req = tx.objectStore(STORE_NAME).getAll();
                    req.onsuccess = async () => {
                        try {
                            const rawRecords = req.result;
                            const decryptedRecords = await Promise.all(rawRecords.map(async (rec) => {
                                try {
                                    const dec = await CryptoService.decryptData(rec, window.SecureDB.sessionPassword);
                                    if(rec.id === 'clinic_settings') return { ...dec, id: 'clinic_settings', isSettings: true };
                                    return { ...dec, id: rec.id };
                                } catch (e) { return null; }
                            }));
                            const valid = decryptedRecords.filter(r => r !== null && !r.isSettings)
                                .sort((a, b) => new Date(b.testDate || 0) - new Date(a.testDate || 0));
                            resolve(valid);
                        } catch (e) { reject(e); }
                    };
                    req.onerror = () => reject(req.error);
                });
            },
            deleteTest: async (id) => {
                if (!window.SecureDB.sessionPassword) throw new Error("Database locked");
                const db = await dbPromise;
                return new Promise((resolve, reject) => {
                    const tx = db.transaction([STORE_NAME], "readwrite");
                    tx.objectStore(STORE_NAME).delete(id);
                    tx.oncomplete = () => resolve();
                    tx.onerror = (e) => reject(e.target.error);
                });
            },
            saveSettings: async (settings) => {
                if (!window.SecureDB.sessionPassword) throw new Error("Database locked");
                const encryptedData = await CryptoService.encryptData(settings, window.SecureDB.sessionPassword);
                const db = await dbPromise;
                return new Promise((resolve, reject) => {
                    const tx = db.transaction([STORE_NAME], "readwrite");
                    tx.objectStore(STORE_NAME).put({ id: 'clinic_settings', ...encryptedData });
                    tx.oncomplete = () => resolve();
                    tx.onerror = (e) => reject(e.target.error);
                });
            },
            getSettings: async () => {
                if (!window.SecureDB.sessionPassword) throw new Error("Database locked");
                const db = await dbPromise;
                return new Promise((resolve, reject) => {
                    const tx = db.transaction([STORE_NAME], "readonly");
                    const req = tx.objectStore(STORE_NAME).get('clinic_settings');
                    req.onsuccess = async () => {
                        if (!req.result) return resolve(null);
                        try {
                            const dec = await CryptoService.decryptData(req.result, window.SecureDB.sessionPassword);
                            resolve(dec);
                        } catch (e) { resolve(null); }
                    };
                    req.onerror = () => reject(req.error);
                });
            },
            getPatientHistory: async (cNumber) => {
                const allTests = await window.SecureDB.getAllTests();
                return allTests.filter(t => t.cNumber && t.cNumber.toLowerCase() === cNumber.toLowerCase());
            }
        };
    </script>

    <!-- REACT APPLICATION -->
    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;
        const { jsPDF } = window.jspdf;

        // --- INLINE ICONS ---
        const IconBase = ({ children, className, ...props }) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg> );
        const Calculator = (props) => ( <IconBase {...props}><rect width="16" height="20" x="4" y="2" rx="2" /><line x1="8" x2="16" y1="6" y2="6" /><line x1="16" x2="16" y1="14" y2="18" /><path d="M16 10h.01" /><path d="M12 10h.01" /><path d="M8 10h.01" /><path d="M12 14h.01" /><path d="M8 14h.01" /><path d="M12 18h.01" /><path d="M8 18h.01" /></IconBase> );
        const Save = (props) => ( <IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase> );
        const FolderOpen = (props) => ( <IconBase {...props}><path d="m6 14 1.45-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.55 6a2 2 0 0 1-1.94 1.5H4a2 2 0 0 1-2-2V5c0-1.1.9-2 2-2h3.93a2 2 0 0 1 1.66.9l.82 1.2a2 2 0 0 0 1.66.9H18a2 2 0 0 1 2 2v2"/></IconBase> );
        const Trash2 = (props) => ( <IconBase {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase> );
        const CheckCircle2 = (props) => ( <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></IconBase> );
        const RotateCcw = (props) => ( <IconBase {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconBase> );
        const Check = (props) => ( <IconBase {...props}><polyline points="20 6 9 17 4 12"/></IconBase> );
        const X = (props) => ( <IconBase {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase> );
        const BarChart3 = (props) => ( <IconBase {...props}><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></IconBase> );
        const ListChecks = (props) => ( <IconBase {...props}><path d="m3 17 2 2 4-4"/><path d="m3 7 2 2 4-4"/><path d="M13 6h8"/><path d="M13 12h8"/><path d="M13 18h8"/></IconBase> );
        const WholeWord = (props) => ( <IconBase {...props}><rect width="20" height="14" x="2" y="5" rx="2"/><path d="M2 10h20"/></IconBase> );
        const AlertCircle = (props) => ( <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconBase> );
        const HelpCircle = (props) => ( <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></IconBase> );
        const Download = (props) => ( <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconBase> );
        const TrendingUp = (props) => ( <IconBase {...props}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></IconBase> );
        const Search = (props) => ( <IconBase {...props}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconBase> );
        const Loader = (props) => ( <IconBase {...props} className="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></IconBase> );
        const Database = (props) => ( <IconBase {...props}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></IconBase> );
        const FileUp = (props) => ( <IconBase {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M12 12v6"/><path d="m15 15-3-3-3 3"/></IconBase> );
        const HistoryIcon = (props) => ( <IconBase {...props}><path d="M3 3v5h5"/><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/><path d="M12 7v5l4 2"/></IconBase> );
        const Activity = (props) => ( <IconBase {...props}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></IconBase> );
        const Lock = (props) => ( <IconBase {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></IconBase> );
        const Flame = (props) => ( <IconBase {...props}><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.115.385-2.256 1.034-3.222l.173.239a5.32 5.32 0 0 0 2.293 2.483Z"/></IconBase> );
        const SettingsIcon = (props) => ( <IconBase {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconBase> );
        const FileText = (props) => ( <IconBase {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></IconBase> );

        // ... [PHONEME_MAP, PHONEME_GROUPS, LISTS 1A-4A are the same] ...
        const PHONEME_MAP = { "f": "Fricative", "v": "Fricative", "θ": "Fricative", "ð": "Fricative", "s": "Fricative", "z": "Fricative", "ʃ": "Fricative", "ʒ": "Fricative", "h": "Fricative", "tʃ": "Affricate", "dʒ": "Affricate", "p": "Stop", "b": "Stop", "t": "Stop", "d": "Stop", "k": "Stop", "g": "Stop", "m": "Nasal", "n": "Nasal", "ŋ": "Nasal", "l": "Liquid/Glide", "r": "Liquid/Glide", "w": "Liquid/Glide", "j": "Liquid/Glide", "i": "Vowel", "ɪ": "Vowel", "eɪ": "Vowel", "ɛ": "Vowel", "æ": "Vowel", "u": "Vowel", "ʊ": "Vowel", "oʊ": "Vowel", "ɔ": "Vowel", "ɑ": "Vowel", "ʌ": "Vowel", "ɝ": "Vowel", "aɪ": "Vowel", "ɔɪ": "Vowel", "aʊ": "Vowel", "ə": "Vowel", "ɚ": "Vowel" };
        const PHONEME_GROUPS = { "High Frequency (Fricatives, Affricates, Stops)": ["Fricative", "Affricate", "Stop"], "Low Frequency (Nasals, Liquids, Glides, Vowels)": ["Nasal", "Liquid/Glide", "Vowel"] };
        const LIST_1A = [ { i: 1, w: "LAUD", p: ["l", "ɔ", "d"] }, { i: 2, w: "BOAT", p: ["b", "oʊ", "t"] }, { i: 3, w: "POOL", p: ["p", "u", "l"] }, { i: 4, w: "NAG", p: ["n", "æ", "g"] }, { i: 5, w: "LIMB", p: ["l", "ɪ", "m"] }, { i: 6, w: "SHOUT", p: ["ʃ", "aʊ", "t"] }, { i: 7, w: "SUB", p: ["s", "ʌ", "b"] }, { i: 8, w: "VINE", p: ["v", "aɪ", "n"] }, { i: 9, w: "DIME", p: ["d", "aɪ", "m"] }, { i: 10, w: "GOOSE", p: ["g", "u", "s"] }, { i: 11, w: "WHIP", p: ["w", "ɪ", "p"] }, { i: 12, w: "TOUGH", p: ["t", "ʌ", "f"] }, { i: 13, w: "PUFF", p: ["p", "ʌ", "f"] }, { i: 14, w: "KEEN", p: ["k", "i", "n"] }, { i: 15, w: "DEATH", p: ["d", "ɛ", "θ"] }, { i: 16, w: "SELL", p: ["s", "ɛ", "l"] }, { i: 17, w: "TAKE", p: ["t", "eɪ", "k"] }, { i: 18, w: "FALL", p: ["f", "ɔ", "l"] }, { i: 19, w: "RAISE", p: ["r", "eɪ", "z"] }, { i: 20, w: "THIRD", p: ["θ", "ɝ", "d"] }, { i: 21, w: "GAP", p: ["g", "æ", "p"] }, { i: 22, w: "FAT", p: ["f", "æ", "t"] }, { i: 23, w: "MET", p: ["m", "ɛ", "t"] }, { i: 24, w: "JAR", p: ["dʒ", "ɑ", "r"] }, { i: 25, w: "DOOR", p: ["d", "ɔ", "r"] }, { i: 26, w: "LOVE", p: ["l", "ʌ", "v"] }, { i: 27, w: "SURE", p: ["ʃ", "ʊ", "r"] }, { i: 28, w: "KNOCK", p: ["n", "ɑ", "k"] }, { i: 29, w: "CHOICE", p: ["tʃ", "ɔɪ", "s"] }, { i: 30, w: "HASH", p: ["h", "æ", "ʃ"] }, { i: 31, w: "LOT", p: ["l", "ɑ", "t"] }, { i: 32, w: "RAID", p: ["r", "eɪ", "d"] }, { i: 33, w: "HURL", p: ["h", "ɝ", "l"] }, { i: 34, w: "MOON", p: ["m", "u", "n"] }, { i: 35, w: "PAGE", p: ["p", "eɪ", "dʒ"] }, { i: 36, w: "YES", p: ["j", "ɛ", "s"] }, { i: 37, w: "REACH", p: ["r", "i", "tʃ"] }, { i: 38, w: "KING", p: ["k", "ɪ", "ŋ"] }, { i: 39, w: "HOME", p: ["h", "oʊ", "m"] }, { i: 40, w: "RAG", p: ["r", "æ", "g"] }, { i: 41, w: "WHICH", p: ["w", "ɪ", "tʃ"] }, { i: 42, w: "WEEK", p: ["w", "i", "k"] }, { i: 43, w: "SIZE", p: ["s", "aɪ", "z"] }, { i: 44, w: "MODE", p: ["m", "oʊ", "d"] }, { i: 45, w: "BEAN", p: ["b", "i", "n"] }, { i: 46, w: "TIP", p: ["t", "ɪ", "p"] }, { i: 47, w: "CHALK", p: ["tʃ", "ɔ", "k"] }, { i: 48, w: "JAIL", p: ["dʒ", "eɪ", "l"] }, { i: 49, w: "BURN", p: ["b", "ɝ", "n"] }, { i: 50, w: "KITE", p: ["k", "aɪ", "t"] } ];
        const LIST_2A = [ { i: 1, w: "PICK", p: ["p", "ɪ", "k"] }, { i: 2, w: "ROOM", p: ["r", "u", "m"] }, { i: 3, w: "NICE", p: ["n", "aɪ", "s"] }, { i: 4, w: "SAID", p: ["s", "ɛ", "d"] }, { i: 5, w: "FAIL", p: ["f", "eɪ", "l"] }, { i: 6, w: "SOUTH", p: ["s", "aʊ", "θ"] }, { i: 7, w: "WHITE", p: ["w", "aɪ", "t"] }, { i: 8, w: "KEEP", p: ["k", "i", "p"] }, { i: 9, w: "DEAD", p: ["d", "ɛ", "d"] }, { i: 10, w: "LOAF", p: ["l", "oʊ", "f"] }, { i: 11, w: "DAB", p: ["d", "æ", "b"] }, { i: 12, w: "NUMB", p: ["n", "ʌ", "m"] }, { i: 13, w: "JUICE", p: ["dʒ", "u", "s"] }, { i: 14, w: "CHIEF", p: ["tʃ", "i", "f"] }, { i: 15, w: "MERGE", p: ["m", "ɝ", "dʒ"] }, { i: 16, w: "WAG", p: ["w", "æ", "g"] }, { i: 17, w: "RAIN", p: ["r", "eɪ", "n"] }, { i: 18, w: "WITCH", p: ["w", "ɪ", "tʃ"] }, { i: 19, w: "SOAP", p: ["s", "oʊ", "p"] }, { i: 20, w: "YOUNG", p: ["j", "ʌ", "ŋ"] }, { i: 21, w: "TON", p: ["t", "ʌ", "n"] }, { i: 22, w: "KEG", p: ["k", "ɛ", "g"] }, { i: 23, w: "CALM", p: ["k", "ɑ", "m"] }, { i: 24, w: "TOOL", p: ["t", "u", "l"] }, { i: 25, w: "PIKE", p: ["p", "aɪ", "k"] }, { i: 26, w: "MILL", p: ["m", "ɪ", "l"] }, { i: 27, w: "HUSH", p: ["h", "ʌ", "ʃ"] }, { i: 28, w: "SHACK", p: ["ʃ", "æ", "k"] }, { i: 29, w: "READ", p: ["r", "i", "d"] }, { i: 30, w: "ROT", p: ["r", "ɑ", "t"] }, { i: 31, w: "HATE", p: ["h", "eɪ", "t"] }, { i: 32, w: "LIVE", p: ["l", "ɪ", "v"] }, { i: 33, w: "BOOK", p: ["b", "ʊ", "k"] }, { i: 34, w: "VOICE", p: ["v", "ɔɪ", "s"] }, { i: 35, w: "GAZE", p: ["g", "eɪ", "z"] }, { i: 36, w: "PAD", p: ["p", "æ", "d"] }, { i: 37, w: "THOUGHT", p: ["θ", "ɔ", "t"] }, { i: 38, w: "BOUGHT", p: ["b", "ɔ", "t"] }, { i: 39, w: "TURN", p: ["t", "ɝ", "n"] }, { i: 40, w: "CHAIR", p: ["tʃ", "ɛ", "r"] }, { i: 41, w: "LORE", p: ["l", "ɔ", "r"] }, { i: 42, w: "BITE", p: ["b", "aɪ", "t"] }, { i: 43, w: "HAZE", p: ["h", "eɪ", "z"] }, { i: 44, w: "MATCH", p: ["m", "æ", "tʃ"] }, { i: 45, w: "LEARN", p: ["l", "ɝ", "n"] }, { i: 46, w: "SHAWL", p: ["ʃ", "ɔ", "l"] }, { i: 47, w: "DEEP", p: ["d", "i", "p"] }, { i: 48, w: "GIN", p: ["dʒ", "ɪ", "n"] }, { i: 49, w: "GOAL", p: ["g", "oʊ", "l"] }, { i: 50, w: "FAR", p: ["f", "ɑ", "r"] } ];
        const LIST_3A = [ { i: 1, w: "BASE", p: ["b", "eɪ", "s"] }, { i: 2, w: "MESS", p: ["m", "ɛ", "s"] }, { i: 3, w: "CAUSE", p: ["k", "ɔ", "z"] }, { i: 4, w: "MOP", p: ["m", "ɑ", "p"] }, { i: 5, w: "GOOD", p: ["g", "ʊ", "d"] }, { i: 6, w: "LUCK", p: ["l", "ʌ", "k"] }, { i: 7, w: "WALK", p: ["w", "ɔ", "k"] }, { i: 8, w: "YOUTH", p: ["j", "u", "θ"] }, { i: 9, w: "PAIN", p: ["p", "eɪ", "n"] }, { i: 10, w: "DATE", p: ["d", "eɪ", "t"] }, { i: 11, w: "PEARL", p: ["p", "ɝ", "l"] }, { i: 12, w: "SEARCH", p: ["s", "ɝ", "tʃ"] }, { i: 13, w: "DITCH", p: ["d", "ɪ", "tʃ"] }, { i: 14, w: "TALK", p: ["t", "ɔ", "k"] }, { i: 15, w: "RING", p: ["r", "ɪ", "ŋ"] }, { i: 16, w: "GERM", p: ["dʒ", "ɝ", "m"] }, { i: 17, w: "LIFE", p: ["l", "aɪ", "f"] }, { i: 18, w: "TEAM", p: ["t", "i", "m"] }, { i: 19, w: "LID", p: ["l", "ɪ", "d"] }, { i: 20, w: "POLE", p: ["p", "oʊ", "l"] }, { i: 21, w: "RODE", p: ["r", "oʊ", "d"] }, { i: 22, w: "SHALL", p: ["ʃ", "æ", "l"] }, { i: 23, w: "LATE", p: ["l", "eɪ", "t"] }, { i: 24, w: "CHEEK", p: ["tʃ", "i", "k"] }, { i: 25, w: "BEG", p: ["b", "ɛ", "g"] }, { i: 26, w: "GUN", p: ["g", "ʌ", "n"] }, { i: 27, w: "JUG", p: ["dʒ", "ʌ", "g"] }, { i: 28, w: "SHEEP", p: ["ʃ", "i", "p"] }, { i: 29, w: "FIVE", p: ["f", "aɪ", "v"] }, { i: 30, w: "RUSH", p: ["r", "ʌ", "ʃ"] }, { i: 31, w: "RAT", p: ["r", "æ", "t"] }, { i: 32, w: "VOID", p: ["v", "ɔɪ", "d"] }, { i: 33, w: "WIRE", p: ["w", "aɪ", "r"] }, { i: 34, w: "HALF", p: ["h", "æ", "f"] }, { i: 35, w: "NOTE", p: ["n", "oʊ", "t"] }, { i: 36, w: "WHEN", p: ["w", "ɛ", "n"] }, { i: 37, w: "NAME", p: ["n", "eɪ", "m"] }, { i: 38, w: "THIN", p: ["θ", "ɪ", "n"] }, { i: 39, w: "TELL", p: ["t", "ɛ", "l"] }, { i: 40, w: "BAR", p: ["b", "ɑ", "r"] }, { i: 41, w: "MOUSE", p: ["m", "aʊ", "s"] }, { i: 42, w: "HIRE", p: ["h", "aɪ", "r"] }, { i: 43, w: "CAB", p: ["k", "æ", "b"] }, { i: 44, w: "HIT", p: ["h", "ɪ", "t"] }, { i: 45, w: "CHAT", p: ["tʃ", "æ", "t"] }, { i: 46, w: "PHONE", p: ["f", "oʊ", "n"] }, { i: 47, w: "SOUP", p: ["s", "u", "p"] }, { i: 48, w: "DODGE", p: ["d", "ɑ", "dʒ"] }, { i: 49, w: "SEIZE", p: ["s", "i", "z"] }, { i: 50, w: "COOL", p: ["k", "u", "l"] } ];
        const LIST_4A = [ { i: 1, w: "PASS", p: ["p", "æ", "s"] }, { i: 2, w: "DOLL", p: ["d", "ɑ", "l"] }, { i: 3, w: "BACK", p: ["b", "æ", "k"] }, { i: 4, w: "RED", p: ["r", "ɛ", "d"] }, { i: 5, w: "WASH", p: ["w", "ɔ", "ʃ"] }, { i: 6, w: "SOUR", p: ["s", "aʊ", "r"] }, { i: 7, w: "BONE", p: ["b", "oʊ", "n"] }, { i: 8, w: "GET", p: ["g", "ɛ", "t"] }, { i: 9, w: "WHEAT", p: ["w", "i", "t"] }, { i: 10, w: "THUMB", p: ["θ", "ʌ", "m"] }, { i: 11, w: "SALE", p: ["s", "eɪ", "l"] }, { i: 12, w: "YEARN", p: ["j", "ɝ", "n"] }, { i: 13, w: "WIFE", p: ["w", "aɪ", "f"] }, { i: 14, w: "SUCH", p: ["s", "ʌ", "tʃ"] }, { i: 15, w: "NEAT", p: ["n", "i", "t"] }, { i: 16, w: "PEG", p: ["p", "ɛ", "g"] }, { i: 17, w: "MOB", p: ["m", "ɑ", "b"] }, { i: 18, w: "GAS", p: ["g", "æ", "s"] }, { i: 19, w: "CHECK", p: ["tʃ", "ɛ", "k"] }, { i: 20, w: "JOIN", p: ["dʒ", "ɔɪ", "n"] }, { i: 21, w: "LEASE", p: ["l", "i", "s"] }, { i: 22, w: "LONG", p: ["l", "ɔ", "ŋ"] }, { i: 23, w: "CHAIN", p: ["tʃ", "eɪ", "n"] }, { i: 24, w: "KILL", p: ["k", "ɪ", "l"] }, { i: 25, w: "HOLE", p: ["h", "oʊ", "l"] }, { i: 26, w: "LEAN", p: ["l", "i", "n"] }, { i: 27, w: "TAPE", p: ["t", "eɪ", "p"] }, { i: 28, w: "TIRE", p: ["t", "aɪ", "r"] }, { i: 29, w: "DIP", p: ["d", "ɪ", "p"] }, { i: 30, w: "ROSE", p: ["r", "oʊ", "z"] }, { i: 31, w: "CAME", p: ["k", "eɪ", "m"] }, { i: 32, w: "FIT", p: ["f", "ɪ", "t"] }, { i: 33, w: "MAKE", p: ["m", "eɪ", "k"] }, { i: 34, w: "VOTE", p: ["v", "oʊ", "t"] }, { i: 35, w: "JUDGE", p: ["dʒ", "ʌ", "dʒ"] }, { i: 36, w: "FOOD", p: ["f", "u", "d"] }, { i: 37, w: "RIPE", p: ["r", "aɪ", "p"] }, { i: 38, w: "HAVE", p: ["h", "æ", "v"] }, { i: 39, w: "ROUGH", p: ["r", "ʌ", "f"] }, { i: 40, w: "KICK", p: ["k", "ɪ", "k"] }, { i: 41, w: "LOSE", p: ["l", "u", "z"] }, { i: 42, w: "NEAR", p: ["n", "i", "r"] }, { i: 43, w: "PERCH", p: ["p", "ɝ", "tʃ"] }, { i: 44, w: "SHIRT", p: ["ʃ", "ɝ", "t"] }, { i: 45, w: "BATH", p: ["b", "æ", "θ"] }, { i: 46, w: "TIME", p: ["t", "aɪ", "m"] }, { i: 47, w: "HALL", p: ["h", "ɔ", "l"] }, { i: 48, w: "MOOD", p: ["m", "u", "d"] }, { i: 49, w: "DOG", p: ["d", "ɔ", "g"] }, { i: 50, w: "SHOULD", p: ["ʃ", "ʊ", "d"] } ];

        // --- LOOKUP TABLES FOR CRITICAL DIFFERENCES ---
        // 80% CI
        const TABLE_80_N150 = {0: [0, 0], 1: [0, 2], 2: [0, 3], 3: [0, 5], 4: [0, 6], 5: [0, 7], 6: [1, 8], 7: [1, 9], 8: [2, 10], 9: [2, 11], 10: [3, 11], 11: [3, 12], 12: [4, 13], 13: [4, 14], 14: [5, 14], 15: [5, 15], 16: [6, 16], 17: [6, 17], 18: [7, 18], 19: [7, 18], 20: [8, 19], 21: [8, 20], 22: [9, 21], 23: [9, 21], 24: [10, 22], 25: [10, 23], 26: [11, 23], 27: [12, 24], 28: [12, 25], 29: [13, 26], 30: [13, 26], 31: [14, 27], 32: [14, 28], 33: [15, 29], 34: [16, 29], 35: [16, 30], 36: [17, 31], 37: [17, 32], 38: [18, 32], 39: [18, 33], 40: [19, 34], 41: [20, 34], 42: [20, 35], 43: [21, 36], 44: [22, 36], 45: [22, 37], 46: [23, 38], 47: [23, 39], 48: [24, 39], 49: [25, 40], 50: [25, 41], 51: [26, 42], 52: [27, 42], 53: [27, 43], 54: [28, 44], 55: [28, 44], 56: [29, 45], 57: [30, 46], 58: [30, 46], 59: [31, 47], 60: [32, 48], 61: [32, 49], 62: [33, 49], 63: [34, 50], 64: [34, 51], 65: [35, 51], 66: [36, 52], 67: [36, 53], 68: [37, 54], 69: [38, 54], 70: [38, 55], 71: [39, 56], 72: [40, 56], 73: [40, 57], 74: [41, 58], 75: [41, 58], 76: [42, 59], 77: [43, 60], 78: [44, 60], 79: [44, 61], 80: [45, 62], 81: [46, 62], 82: [46, 63], 83: [47, 63], 84: [48, 64], 85: [49, 65], 86: [49, 66], 87: [50, 66], 88: [51, 67], 89: [51, 68], 90: [52, 68], 91: [53, 69], 92: [54, 70], 93: [54, 70], 94: [55, 71], 95: [56, 72], 96: [57, 73], 97: [58, 73], 98: [58, 74], 99: [59, 75], 100: [60, 75]};
        const TABLE_80_N75 = {0: [0, 0], 1: [0, 4], 2: [0, 6], 3: [0, 7], 4: [0, 9], 5: [0, 11], 6: [0, 13], 7: [0, 14], 8: [1, 15], 9: [2, 16], 10: [3, 17], 11: [3, 19], 12: [4, 20], 13: [5, 21], 14: [6, 23], 15: [6, 24], 16: [7, 24], 17: [8, 25], 18: [9, 27], 19: [10, 28], 20: [10, 29], 21: [11, 30], 22: [12, 31], 23: [13, 32], 24: [14, 33], 25: [15, 34], 26: [16, 35], 27: [16, 36], 28: [17, 37], 29: [18, 38], 30: [19, 39], 31: [20, 40], 32: [21, 41], 33: [22, 42], 34: [23, 43], 35: [24, 45], 36: [25, 46], 37: [26, 48], 38: [27, 49], 39: [28, 49], 40: [29, 50], 41: [30, 52], 42: [31, 53], 43: [32, 53], 44: [33, 55], 45: [34, 56], 46: [35, 57], 47: [36, 58], 48: [37, 58], 49: [38, 60], 50: [39, 61], 51: [40, 62], 52: [41, 62], 53: [42, 63], 54: [43, 64], 55: [44, 65], 56: [45, 66], 57: [46, 67], 58: [48, 68], 59: [49, 69], 60: [50, 70], 61: [51, 70], 62: [52, 71], 63: [53, 72], 64: [54, 73], 65: [55, 74], 66: [56, 75], 67: [57, 76], 68: [58, 77], 69: [59, 78], 70: [60, 79], 71: [62, 80], 72: [63, 81], 73: [64, 82], 74: [65, 83], 75: [66, 84], 76: [67, 85], 77: [68, 86], 78: [69, 87], 79: [70, 88], 80: [71, 88], 81: [72, 89], 82: [73, 90], 83: [74, 91], 84: [75, 91], 85: [76, 92], 86: [78, 93], 87: [79, 94], 88: [80, 94], 89: [81, 95], 90: [82, 96], 91: [83, 97], 92: [85, 98], 93: [86, 98], 94: [87, 99], 95: [88, 100], 96: [89, 100], 97: [91, 100], 98: [92, 100], 99: [94, 100], 100: [95, 100]};
        const TABLE_80_N30 = {0: [0, 0], 3: [0, 11], 7: [0, 15], 10: [0, 22], 13: [1, 25], 17: [5, 29], 20: [4, 36], 23: [7, 39], 27: [11, 43], 30: [14, 46], 33: [17, 50], 37: [21, 53], 40: [24, 56], 43: [27, 63], 47: [27, 67], 50: [34, 70], 53: [33, 73], 57: [37, 73], 60: [40, 76], 63: [43, 80], 67: [47, 83], 70: [50, 87], 73: [57, 89], 77: [61, 93], 80: [64, 96], 83: [71, 95], 87: [75, 99], 90: [78, 100], 93: [85, 100], 97: [89, 100], 100: [92, 100]};

        // 95% CI
        const TABLE_95_N150 = {0: [0, 0], 1: [0, 3], 2: [0, 5], 3: [0, 5], 4: [0, 7], 5: [0, 8], 6: [0, 8], 7: [0, 9], 8: [0, 11], 9: [1, 11], 10: [1, 12], 11: [2, 13], 12: [3, 14], 13: [3, 15], 14: [4, 16], 15: [5, 16], 16: [5, 17], 17: [6, 18], 18: [6, 19], 19: [7, 20], 20: [8, 20], 21: [8, 21], 22: [9, 22], 23: [9, 23], 24: [10, 24], 25: [11, 24], 26: [11, 25], 27: [12, 26], 28: [13, 27], 29: [13, 28], 30: [14, 28], 31: [15, 29], 32: [15, 30], 33: [16, 31], 34: [17, 32], 35: [17, 32], 36: [18, 33], 37: [19, 34], 38: [19, 35], 39: [20, 36], 40: [21, 36], 41: [22, 37], 42: [22, 38], 43: [23, 39], 44: [24, 40], 45: [25, 41], 46: [25, 42], 47: [26, 42], 48: [27, 43], 49: [28, 44], 50: [29, 45], 51: [29, 46], 52: [30, 47], 53: [31, 48], 54: [32, 49], 55: [32, 49], 56: [33, 50], 57: [34, 51], 58: [35, 52], 59: [36, 53], 60: [37, 54], 61: [37, 54], 62: [38, 55], 63: [39, 56], 64: [40, 57], 65: [41, 58], 66: [42, 59], 67: [43, 60], 68: [44, 61], 69: [45, 62], 70: [45, 63], 71: [46, 63], 72: [47, 64], 73: [48, 65], 74: [49, 66], 75: [50, 67], 76: [51, 68], 77: [52, 69], 78: [53, 70], 79: [54, 71], 80: [55, 71], 81: [56, 72], 82: [57, 73], 83: [58, 74], 84: [59, 75], 85: [60, 76], 86: [61, 77], 87: [62, 78], 88: [63, 78], 89: [64, 79], 90: [65, 80], 91: [67, 81], 92: [68, 82], 93: [69, 83], 94: [70, 84], 95: [71, 84], 96: [72, 85], 97: [73, 86], 98: [75, 87], 99: [76, 88], 100: [78, 89]};
        const TABLE_95_N75 = {0: [0, 0], 1: [0, 7], 3: [0, 8], 4: [0, 11], 5: [0, 13], 7: [0, 15], 8: [0, 17], 9: [1, 19], 11: [2, 20], 12: [3, 22], 13: [3, 23], 15: [4, 25], 16: [5, 26], 17: [6, 27], 19: [7, 28], 20: [8, 30], 21: [9, 31], 23: [9, 33], 24: [10, 34], 25: [11, 35], 27: [12, 36], 28: [13, 38], 29: [14, 39], 31: [15, 40], 32: [16, 41], 33: [17, 42], 35: [18, 44], 36: [19, 45], 37: [20, 46], 39: [21, 47], 40: [22, 48], 41: [23, 49], 43: [24, 51], 44: [25, 52], 45: [27, 53], 47: [28, 54], 48: [29, 56], 49: [30, 56], 51: [31, 58], 52: [32, 59], 53: [33, 60], 55: [34, 61], 56: [35, 62], 57: [37, 63], 59: [38, 64], 60: [39, 65], 61: [40, 66], 63: [41, 67], 64: [42, 68], 65: [44, 69], 67: [45, 70], 68: [46, 71], 69: [47, 72], 71: [49, 73], 72: [50, 74], 73: [51, 75], 75: [52, 75], 76: [54, 76], 77: [55, 77], 79: [56, 78], 80: [57, 79], 81: [59, 80], 83: [60, 81], 84: [62, 82], 85: [63, 83], 87: [64, 84], 88: [66, 85], 89: [67, 85], 91: [69, 87], 92: [71, 88], 93: [72, 89], 95: [74, 90], 96: [76, 91], 97: [77, 92], 99: [80, 93], 100: [83, 94]};
        const TABLE_95_N30 = {0: [0, 0], 3: [0, 17], 7: [0, 23], 10: [0, 30], 13: [0, 33], 17: [0, 40], 20: [3, 43], 23: [3, 47], 27: [7, 50], 30: [7, 53], 33: [10, 57], 37: [17, 60], 40: [20, 60], 43: [23, 67], 47: [27, 67], 50: [27, 73], 53: [33, 73], 57: [33, 77], 60: [40, 80], 63: [43, 83], 67: [50, 87], 70: [50, 90], 73: [50, 93], 77: [57, 97], 80: [60, 97], 83: [63, 100], 87: [67, 100], 90: [70, 100], 93: [77, 100], 97: [83, 100], 100: [90, 100]};

        // --- HELPER FUNCTIONS ---
        // Same list getter, stats calc, critical limits as before
        const getListData = (listId) => { switch(listId) { case '1A': return LIST_1A; case '2A': return LIST_2A; case '3A': return LIST_3A; case '4A': return LIST_4A; default: return LIST_1A; } };
        const calculateStats = (listId, section, scores, limitTo10 = false) => {
            const allWords = getListData(listId);
            let visibleWords = allWords;
            if (section === 'first') visibleWords = allWords.slice(0, 25);
            else if (section === 'first_10') visibleWords = allWords.slice(0, 10);
            else if (section === 'second') visibleWords = allWords.slice(25, 50);
            else if (section === 'second_10') visibleWords = allWords.slice(25, 35);
            else if (section === 'full') visibleWords = allWords;
            if (limitTo10) { visibleWords = visibleWords.slice(0, 10); }

            let totalPhonemes = 0; let correctPhonemes = 0; let correctWords = 0; let totalWords = visibleWords.length;
            visibleWords.forEach(word => {
                let wordCorrectCount = 0; let wordPhonemeCount = 0;
                word.p.forEach((phoneme, pIndex) => {
                    if (phoneme === '-') return;
                    wordPhonemeCount++; totalPhonemes++;
                    const key = `${listId}_${word.i}_${pIndex}`;
                    if (scores[key]) { correctPhonemes++; wordCorrectCount++; }
                });
                if (wordCorrectCount === wordPhonemeCount && wordPhonemeCount > 0) { correctWords++; }
            });
            return {
                totalPhonemes, correctPhonemes, phonemePercent: totalPhonemes === 0 ? 0 : Math.round((correctPhonemes / totalPhonemes) * 100),
                correctWords, totalWords, wordPercent: totalWords === 0 ? 0 : Math.round((correctWords / totalWords) * 100), visibleWords
            };
        };

        // Standard Thornton & Raffin function for words (N=10, 25, 50)
        const getTheta = (x, n) => Math.asin(Math.sqrt(x / (n + 1))) + Math.asin(Math.sqrt((x + 1) / (n + 1)));

        // Critical Limits Function using Custom Tables for Phonemes
        const getCriticalLimits = (scorePercent, n, confidence) => {
            // Helper to get nearest key in lookup table
            const getRange = (table, score) => {
                const keys = Object.keys(table).map(Number).sort((a,b) => a - b);
                // Find closest key
                const closest = keys.reduce((prev, curr) => {
                    return (Math.abs(curr - score) < Math.abs(prev - score) ? curr : prev);
                });
                const limits = table[closest];
                return { lower: limits[0], upper: limits[1] };
            };

            // Phoneme Scoring Logic
            // N values are approximate ranges to catch standard NU-6 lengths
            if (n >= 25 && n <= 40) { // ~30 Phonemes (10 Words)
                if (confidence === 80) return getRange(TABLE_80_N30, scorePercent);
                if (confidence === 95) return getRange(TABLE_95_N30, scorePercent);
            }
            else if (n >= 60 && n <= 90) { // ~75 Phonemes (25 Words)
                if (confidence === 80) return getRange(TABLE_80_N75, scorePercent);
                if (confidence === 95) return getRange(TABLE_95_N75, scorePercent);
            }
            else if (n >= 120 && n <= 170) { // ~150 Phonemes (50 Words)
                if (confidence === 80) return getRange(TABLE_80_N150, scorePercent);
                if (confidence === 95) return getRange(TABLE_95_N150, scorePercent);
            }

            // FALLBACK: Standard Binomial Calculation for Words (N=10, 25, 50)
            const x = Math.round((scorePercent / 100) * n);
            const theta = getTheta(x, n);
            let variance = n >= 50 ? 1 / (n + 0.5) : 1 / (n + 1);
            const seDiff = Math.sqrt(2 * variance);
            const z = confidence === 95 ? 1.96 : 1.2816;
            const lowerTheta = theta - (z * seDiff);
            const upperTheta = theta + (z * seDiff);
            let lowerLimit = 0; let upperLimit = 100;
            for (let i = 0; i <= n; i++) { if (getTheta(i, n) >= lowerTheta) { lowerLimit = Math.round((i/n)*100); break; } }
            for (let i = n; i >= 0; i--) { if (getTheta(i, n) <= upperTheta) { upperLimit = Math.round((i/n)*100); break; } }
            return { lower: lowerLimit, upper: upperLimit };
        };

        function calculateMarginOfError(scorePercentage, n, zScore) {
            const p = scorePercentage / 100.0;
            const standardError = Math.sqrt((p * (1 - p)) / n);
            return zScore * standardError * 100;
        }

        function generateData(n, zScore) {
            const data = [];
            for (let score = 0; score <= 100; score += 2) {
                const moe = calculateMarginOfError(score, n, zScore);
                data.push({x: score, y: moe});
            }
            return data;
        }

        // --- COMPONENTS ---
        // ... (Remaining components LoginModal, PhonemeFrequencyModal, DiagnosticsPanel, etc. remain unchanged)

        // ... (App component and Chart generation logic remains same, just utilizing updated getCriticalLimits)

        // For brevity, re-including the unchanged components structure
        // ...

        const LoginModal = ({ onLogin, isSetup }) => {
            const [password, setPassword] = useState('');
            const [confirm, setConfirm] = useState('');
            const [error, setError] = useState('');
            const handleSubmit = async (e) => {
                e.preventDefault(); setError('');
                if (isSetup) { const success = await window.SecureDB.login(password); if (success) onLogin(); else setError("Incorrect password."); }
                else { if (password !== confirm) { setError("Passwords do not match."); return; } if (password.length < 6) { setError("Password must be at least 6 characters."); return; } try { await window.SecureDB.setupPassword(password); onLogin(); } catch (err) { setError("Setup failed."); } }
            };
            return ( <div className="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center p-4"> <div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-8 relative"> <div className="flex justify-center mb-6 text-blue-600"><Lock className="w-12 h-12" /></div> <h2 className="text-2xl font-bold text-center text-slate-800 mb-2">{isSetup ? "Unlock Database" : "Set Encryption Password"}</h2> <p className="text-center text-slate-500 mb-6 text-sm">{isSetup ? "Enter your password to access patient records." : "Create a password to encrypt your local database. If you lose this, data cannot be recovered."}</p> <form onSubmit={handleSubmit} className="space-y-4"> <div><label className="block text-xs font-bold text-slate-500 mb-1 uppercase">Password</label><input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" autoFocus /></div> {!isSetup && (<div><label className="block text-xs font-bold text-slate-500 mb-1 uppercase">Confirm Password</label><input type="password" value={confirm} onChange={e => setConfirm(e.target.value)} className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" /></div>)} {error && <div className="text-red-600 text-sm text-center font-medium">{error}</div>} <button type="submit" className="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold transition-colors">{isSetup ? "Unlock" : "Set Password & Unlock"}</button> </form> </div> </div> );
        };

        const SettingsModal = ({ isOpen, onClose, initialSettings, onSave }) => {
             const [appTitle, setAppTitle] = useState(initialSettings?.appTitle || 'NU-6 Phoneme Scorer');
            const [clinicName, setClinicName] = useState(initialSettings?.clinicName || '');
            const [audiologistName, setAudiologistName] = useState(initialSettings?.audiologistName || '');
            const [licenseNumber, setLicenseNumber] = useState(initialSettings?.licenseNumber || '');
            useEffect(() => { if(isOpen && initialSettings) { setAppTitle(initialSettings.appTitle || 'NU-6 Phoneme Scorer'); setClinicName(initialSettings.clinicName || ''); setAudiologistName(initialSettings.audiologistName || ''); setLicenseNumber(initialSettings.licenseNumber || ''); } }, [isOpen, initialSettings]);
            const handleSubmit = (e) => { e.preventDefault(); onSave({ appTitle, clinicName, audiologistName, licenseNumber }); onClose(); };
            if(!isOpen) return null;
            return ( <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"> <div className="bg-white rounded-xl shadow-lg w-full max-w-md p-6 relative"> <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><X className="w-5 h-5"/></button> <h2 className="text-xl font-bold text-slate-800 mb-4">App & Clinic Settings</h2> <form onSubmit={handleSubmit} className="space-y-4"> <div><label className="block text-xs font-bold text-slate-500 uppercase">App Title (Top Left)</label><input type="text" className="w-full border p-2 rounded bg-slate-50" value={appTitle} onChange={e => setAppTitle(e.target.value)} /></div> <div><label className="block text-xs font-bold text-slate-500 uppercase">Clinic Name</label><input type="text" className="w-full border p-2 rounded" value={clinicName} onChange={e => setClinicName(e.target.value)} /></div> <div><label className="block text-xs font-bold text-slate-500 uppercase">Audiologist Name</label><input type="text" className="w-full border p-2 rounded" value={audiologistName} onChange={e => setAudiologistName(e.target.value)} /></div> <div><label className="block text-xs font-bold text-slate-500 uppercase">License #</label><input type="text" className="w-full border p-2 rounded" value={licenseNumber} onChange={e => setLicenseNumber(e.target.value)} /></div> <button type="submit" className="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700">Save Settings</button> </form> </div> </div> );
        };

        // NEW: Comparative Ease Scale Modal
        const ComparativeEaseScaleModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;
            const captureRef = useRef(null);

            const handleDownload = async () => {
                if (!captureRef.current) return;
                try {
                    const canvas = await html2canvas(captureRef.current, { scale: 2, backgroundColor: '#ffffff' });
                    const link = document.createElement('a');
                    link.download = 'Comparative_Listening_Scale.png';
                    link.href = canvas.toDataURL();
                    link.click();
                } catch (err) {
                    console.error(err);
                    alert("Export failed");
                }
            };

            const scaleData = [
                { val: 10, label: "Much Easier", desc: "Significant improvement. Listening requires almost no effort compared to before.", color: "bg-emerald-100 border-emerald-300", textColor: "text-emerald-800" },
                { val: 9, label: "Very Easy", desc: "A major improvement in clarity and comfort.", color: "bg-emerald-50 border-emerald-200", textColor: "text-emerald-700" },
                { val: 8, label: "Easier", desc: "Noticeably better. Listening is clearly less straining.", color: "bg-green-50 border-green-200", textColor: "text-green-700" },
                { val: 7, label: "Moderately Easier", desc: "Definite improvement, though some effort remains.", color: "bg-lime-50 border-lime-200", textColor: "text-lime-700" },
                { val: 6, label: "Slightly Easier", desc: "A small but noticeable improvement.", color: "bg-yellow-50 border-yellow-200", textColor: "text-yellow-700" },
                { val: 5, label: "No Difference", desc: "Listening effort is exactly the same as the previous condition.", color: "bg-slate-100 border-slate-300", textColor: "text-slate-800" },
                { val: 4, label: "Slightly Harder", desc: "A small increase in difficulty or strain.", color: "bg-orange-50 border-orange-200", textColor: "text-orange-700" },
                { val: 3, label: "Moderately Harder", desc: "Noticeably more difficult to follow speech.", color: "bg-orange-100 border-orange-300", textColor: "text-orange-800" },
                { val: 2, label: "Harder", desc: "Increased strain. Listening is clearly more fatiguing.", color: "bg-red-50 border-red-200", textColor: "text-red-700" },
                { val: 1, label: "Very Hard", desc: "Much more difficult. Requires intense concentration.", color: "bg-red-100 border-red-300", textColor: "text-red-800" },
                { val: 0, label: "Much Harder", desc: "Impossible or significantly worse than before.", color: "bg-red-300 border-red-400", textColor: "text-red-900" }
            ];

            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-lg w-full max-w-lg p-6 relative max-h-[90vh] overflow-y-auto">
                        <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><X className="w-5 h-5"/></button>
                        <div ref={captureRef} className="p-2">
                            <div className="text-center mb-6">
                                <h1 className="text-2xl font-bold text-slate-800">Comparative Listening Scale</h1>
                                <p className="text-slate-500 text-sm mt-1">...compared to the previous condition.</p>
                                <div className="flex justify-center items-center gap-4 mt-4 text-xs font-bold uppercase tracking-widest text-slate-400">
                                    <span>Harder</span>
                                    <div className="w-24 h-0.5 bg-gradient-to-r from-red-400 via-slate-300 to-emerald-400"></div>
                                    <span>Easier</span>
                                </div>
                            </div>
                            <div className="space-y-1">
                                {scaleData.map(item => (
                                    <div key={item.val} className={`flex items-center gap-4 p-3 rounded-lg border ${item.color} mb-2`}>
                                        <div className={`flex flex-col items-center justify-center w-12 h-12 bg-white/60 rounded-full font-bold text-xl shadow-sm shrink-0 ${item.textColor}`}>
                                            {item.val}
                                        </div>
                                        <div>
                                            <div className={`font-bold text-base ${item.textColor}`}>{item.label}</div>
                                            <div className="text-xs opacity-80 text-slate-600">{item.desc}</div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div className="mt-4 flex justify-center gap-3">
                            <button onClick={handleDownload} className="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors shadow-sm"><Download className="w-4 h-4" /> PNG</button>
                            <button onClick={onClose} className="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-medium">Close</button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            // ... (State setup) ...
            const [patientName, setPatientName] = useState('');
            const [cNumber, setCNumber] = useState('');
            const [testDate, setTestDate] = useState(new Date().toISOString().split('T')[0]);
            const [activeTab, setActiveTab] = useState('scoring');
            const [activeTestId, setActiveTestId] = useState('A');
            const [confidenceLevel, setConfidenceLevel] = useState(80);
            const [clearConfirm, setClearConfirm] = useState(false);
            const [showScaleModal, setShowScaleModal] = useState(false);
            const [showChartModal, setShowChartModal] = useState(false);
            const [showPhonemeModal, setShowPhonemeModal] = useState(false);
            const [showLoadModal, setShowLoadModal] = useState(false);
            const [currentTestId, setCurrentTestId] = useState(null);
            const [showSettingsModal, setShowSettingsModal] = useState(false);
            const [clinicSettings, setClinicSettings] = useState(null);
            const [showComparativeScaleModal, setShowComparativeScaleModal] = useState(false);
            const [isLocked, setIsLocked] = useState(true);
            const [hasPassword, setHasPassword] = useState(false);
            const [dbReady, setDbReady] = useState(false);
            const fileInputRef = useRef(null);

            useEffect(() => { const init = async () => { const isSetup = await window.SecureDB.isSetup(); setHasPassword(isSetup); setDbReady(true); }; init(); }, []);
            useEffect(() => { if (!isLocked) { window.SecureDB.getSettings().then(s => setClinicSettings(s)); } }, [isLocked]);

            const [tests, setTests] = useState({
                A: { id: 'A', listId: '3A', section: 'second_10', scoringMode: 'word', condition: 'Unaided', deviceModel: '', level: '', snr: '', scores: {}, limitTo10: false, askedContinue: false },
                B: { id: 'B', listId: '4A', section: 'second_10', scoringMode: 'word', condition: 'New Tech', deviceModel: '', level: '', snr: '', scores: {}, limitTo10: false, askedContinue: false },
                comparativeEase: 5
            });

            // ... (Helper memos: activeTest, statsA, statsB, limits ...) ...
            const activeTest = tests[activeTestId];
            const statsA = useMemo(() => calculateStats(tests.A.listId, tests.A.section, tests.A.scores, tests.A.limitTo10), [tests.A]);
            const statsB = useMemo(() => calculateStats(tests.B.listId, tests.B.section, tests.B.scores, tests.B.limitTo10), [tests.B]);
            const activeStats = activeTestId === 'A' ? statsA : statsB;
            const wordCriticalLimits = useMemo(() => { if (statsA.totalWords === 0) return { lower: 0, upper: 100 }; return getCriticalLimits(statsA.wordPercent, statsA.totalWords, confidenceLevel); }, [statsA.wordPercent, statsA.totalWords, confidenceLevel]);
            const phonemeCriticalLimits = useMemo(() => { if (statsA.totalPhonemes === 0) return { lower: 0, upper: 100 }; return getCriticalLimits(statsA.phonemePercent, statsA.totalPhonemes, confidenceLevel); }, [statsA.phonemePercent, statsA.totalPhonemes, confidenceLevel]);
            const isWordDiffSig = statsB.wordPercent < wordCriticalLimits.lower || statsB.wordPercent > wordCriticalLimits.upper;
            const isPhonemeDiffSig = statsB.phonemePercent < phonemeCriticalLimits.lower || statsB.phonemePercent > phonemeCriticalLimits.upper;
            const getSectionOptions = (testId) => { const options = [ { val: 'first_10', label: '1st Half (First 10)', n: 10 }, { val: 'first', label: '1st Half (1-25)', n: 25 }, { val: 'second_10', label: '2nd Half (First 10)', n: 10 }, { val: 'second', label: '2nd Half (26-50)', n: 25 }, { val: 'full', label: 'Full List (1-50)', n: 50 } ]; if (testId === 'A') return options; const aSection = tests.A.section; const aIsTen = aSection.includes('_10'); const aIsHalf = aSection === 'first' || aSection === 'second'; const aIsFull = aSection === 'full'; return options.filter(opt => { if (aIsTen) return opt.n === 10; if (aIsHalf) return opt.n === 25; if (aIsFull) return opt.n === 50; return true; }); };

            // ... (Update/Toggle handlers) ...
            const updateActiveTest = (field, value) => { if (field === 'scoringMode' && value === 'phoneme') setShowPhonemeModal(true); setTests(prev => { const newTests = { ...prev, [activeTestId]: { ...prev[activeTestId], [field]: value } }; if (activeTestId === 'A' && field === 'section') { const isTen = value.includes('_10'); const isHalf = value === 'first' || value === 'second'; const isFull = value === 'full'; let bSection = newTests.B.section; if (isTen) { if (!bSection.includes('_10')) bSection = 'first_10'; } else if (isHalf) { if (bSection !== 'first' && bSection !== 'second') bSection = 'first'; } else if (isFull) { bSection = 'full'; } newTests.B.section = bSection; } if (field === 'scoringMode') { newTests.A.scoringMode = value; newTests.B.scoringMode = value; } if (activeTestId === 'A' && (field === 'level' || field === 'snr')) { newTests.B[field] = value; } return newTests; }); };
            const updateComparativeEase = (value) => { setTests(prev => ({ ...prev, comparativeEase: value })); };
            const togglePhoneme = (wordIndex, pIndex) => { const listId = activeTest.listId; const key = `${listId}_${wordIndex}_${pIndex}`; setTests(prev => { const currentScores = prev[activeTestId].scores; const newScores = { ...currentScores, [key]: !currentScores[key] }; return { ...prev, [activeTestId]: { ...prev[activeTestId], scores: newScores } }; }); };
            const setWordScore = (wordIndex, isCorrect) => { const listId = activeTest.listId; const wordData = activeStats.visibleWords.find(w => w.i === wordIndex); if (!wordData) return; setTests(prev => { const currentScores = { ...prev[activeTestId].scores }; let shouldClear = false; let currentIsAllCorrect = true; let currentIsAllIncorrect = true; let hasAnyScore = false; wordData.p.forEach((p, idx) => { if (p !== '-') { const val = currentScores[`${listId}_${wordIndex}_${idx}`]; if (val !== undefined) hasAnyScore = true; if (val !== true) currentIsAllCorrect = false; if (val !== false) currentIsAllIncorrect = false; } }); if (isCorrect && currentIsAllCorrect && hasAnyScore) shouldClear = true; if (!isCorrect && currentIsAllIncorrect && hasAnyScore) shouldClear = true; wordData.p.forEach((p, idx) => { if (p !== '-') { if (shouldClear) { delete currentScores[`${listId}_${wordIndex}_${idx}`]; } else { currentScores[`${listId}_${wordIndex}_${idx}`] = isCorrect; } } }); return { ...prev, [activeTestId]: { ...prev[activeTestId], scores: currentScores } }; }); };
            const toggleWordCorrect = (wordIndex) => { const listId = activeTest.listId; const wordData = activeStats.visibleWords.find(w => w.i === wordIndex); if (!wordData) return; setTests(prev => { const currentScores = { ...prev[activeTestId].scores }; let isFullyCorrect = true; wordData.p.forEach((p, idx) => { if (p !== '-' && !currentScores[`${listId}_${wordIndex}_${idx}`]) { isFullyCorrect = false; } }); wordData.p.forEach((p, idx) => { if (p !== '-') { if (isFullyCorrect) { delete currentScores[`${listId}_${wordIndex}_${idx}`]; } else { currentScores[`${listId}_${wordIndex}_${idx}`] = true; } } }); return { ...prev, [activeTestId]: { ...prev[activeTestId], scores: currentScores } }; }); };
            const markAll = (correct) => { const listData = activeStats.visibleWords; const listId = activeTest.listId; setTests(prev => { const newScores = { ...prev[activeTestId].scores }; listData.forEach(word => { word.p.forEach((phoneme, pIndex) => { if (phoneme === '-') return; const key = `${listId}_${word.i}_${pIndex}`; if(correct) newScores[key] = true; else delete newScores[key]; }); }); return { ...prev, [activeTestId]: { ...prev[activeTestId], scores: newScores, askedContinue: true } }; }); };

            const resetForm = () => {
                setCurrentTestId(null);
                setPatientName('');
                setCNumber('');
                setTestDate(new Date().toISOString().split('T')[0]);
                setTests({
                    A: { id: 'A', listId: '3A', section: 'second_10', scoringMode: 'word', condition: 'Unaided', deviceModel: '', level: '', snr: '', scores: {}, limitTo10: false, askedContinue: false },
                    B: { id: 'B', listId: '4A', section: 'second_10', scoringMode: 'word', condition: 'New Tech', deviceModel: '', level: '', snr: '', scores: {}, limitTo10: false, askedContinue: false },
                    comparativeEase: 5
                });
                setActiveTestId('A');
                setActiveTab('scoring');
                setClearConfirm(false);
            };

            const handleSave = async () => { if (!patientName.trim()) { alert("Please enter a Patient Name."); return; } const data = { id: currentTestId, patientName, cNumber, testDate, tests, activeTestId, activeTab, confidenceLevel }; try { const savedId = await window.SecureDB.saveTest(data); setCurrentTestId(savedId); alert("Test encrypted and saved to local database successfully!"); } catch(e) { console.error("Save error", e); alert("Failed to save to local database."); } };
            const handleLoadTest = (loadedData) => { if (loadedData) { setCurrentTestId(loadedData.id); setPatientName(loadedData.patientName || ''); setCNumber(loadedData.cNumber || ''); setTestDate(loadedData.testDate || new Date().toISOString().split('T')[0]); setTests(loadedData.tests); setActiveTestId(loadedData.activeTestId || 'A'); setActiveTab(loadedData.activeTab || 'scoring'); if(loadedData.confidenceLevel) setConfidenceLevel(loadedData.confidenceLevel); } };
            const handleDeleteCurrentRecord = async () => { if (!currentTestId) return; if (confirm("Are you sure you want to delete this record from the database?")) { try { await window.SecureDB.deleteTest(currentTestId); alert("Record deleted."); resetForm(); } catch (e) { console.error(e); alert("Failed to delete record."); } } };
            const handleExportDB = async () => { try { const allData = await window.SecureDB.getAllTests(); if(!confirm("Warning: This will export unencrypted patient data to a JSON file. Ensure you save this file to a secure location.")) return; const jsonString = JSON.stringify(allData, null, 2); const blob = new Blob([jsonString], { type: "application/json" }); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.href = url; link.download = `NU6_Database_Export_DECRYPTED_${new Date().toISOString().split('T')[0]}.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link); } catch (err) { console.error("Export failed:", err); alert("Failed to export database."); } };
            const handleExportFHIR = async () => { try { const allData = await window.SecureDB.getAllTests(); if(!confirm("Warning: This will export unencrypted patient data to a FHIR Bundle. Ensure you save this file to a secure location.")) return; const fhirBundle = { resourceType: "Bundle", type: "collection", entry: allData.map(record => ({ resource: { resourceType: "Observation", status: "final", code: { coding: [{ system: "http://loinc.org", code: "52023-9", display: "Speech discrimination Score" }] }, subject: { display: `${record.patientName} (ID: ${record.cNumber})` }, effectiveDateTime: new Date(record.testDate).toISOString(), valueQuantity: { value: calculateStats(record.tests.A.listId, record.tests.A.section, record.tests.A.scores, record.tests.A.limitTo10).wordPercent, unit: "%", system: "http://unitsofmeasure.org", code: "%" }, method: { text: `Condition: ${record.tests.A.condition}, List: ${record.tests.A.listId}` } } })) }; const jsonString = JSON.stringify(fhirBundle, null, 2); const blob = new Blob([jsonString], { type: "application/json+fhir" }); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.href = url; link.download = `NU6_FHIR_Export_${new Date().toISOString().split('T')[0]}.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link); } catch (err) { console.error("FHIR Export failed:", err); alert("Failed to export FHIR bundle."); } };
            const handleOpenClick = () => fileInputRef.current.click(); // Unused
            const clearAllData = () => { if (clearConfirm) { resetForm(); } else { setClearConfirm(true); setTimeout(() => setClearConfirm(false), 3000); } };

            const handleSaveSettings = async (newSettings) => {
                try {
                    await window.SecureDB.saveSettings(newSettings);
                    setClinicSettings(newSettings);
                    alert("Settings saved successfully.");
                } catch(e) { console.error(e); alert("Failed to save settings."); }
            };

            const handleExportPDF = () => {
                const doc = new window.jspdf.jsPDF();
                const displayTitle = clinicSettings?.appTitle || 'NU-6 Phoneme Scorer';
                const formatCondition = (test) => test.deviceModel ? `${test.condition}\n(${test.deviceModel})` : test.condition;

                doc.setFontSize(18);
                doc.text(displayTitle, 105, 20, { align: 'center' });

                doc.setFontSize(12);
                if (clinicSettings) {
                    doc.text(clinicSettings.clinicName || "", 20, 30);
                    doc.setFontSize(10);
                    doc.text(`Audiologist: ${clinicSettings.audiologistName || ""}`, 20, 36);
                    doc.text(`License: ${clinicSettings.licenseNumber || ""}`, 20, 42);
                }

                doc.setFontSize(12);
                doc.text(`Patient: ${patientName}`, 140, 30);
                doc.text(`ID: ${cNumber}`, 140, 36);
                doc.text(`Date: ${testDate}`, 140, 42);

                doc.line(20, 46, 190, 46);

                doc.autoTable({
                    startY: 50,
                    head: [['Test', 'Condition', 'List', 'Level', 'SNR', 'Word Score', 'Phoneme Score']],
                    body: [
                        ['Test A', formatCondition(tests.A), tests.A.listId, `${tests.A.level || '--'} dB`, `${tests.A.snr || '--'} dB`, `${statsA.wordPercent}%`, `${statsA.phonemePercent}%`],
                        ['Test B', formatCondition(tests.B), tests.B.listId, `${tests.B.level || '--'} dB`, `${tests.B.snr || '--'} dB`, `${statsB.wordPercent}%`, `${statsB.phonemePercent}%`]
                    ],
                    theme: 'striped',
                    headStyles: { fillColor: [66, 135, 245] }
                });

                let finalY = doc.lastAutoTable.finalY + 10;
                doc.setFontSize(11);
                doc.text("Statistical Significance (Thornton & Raffin, 1978):", 20, finalY);
                finalY += 6;
                doc.setFontSize(10);
                doc.text(`Confidence Level: ${confidenceLevel}%`, 20, finalY);
                finalY += 5;
                const isSig = isWordDiffSig ? "YES - Significant Difference" : "NO - Within Critical Limits";
                doc.text(`Word Score Difference: ${isSig}`, 20, finalY);

                if (tests.A.scoringMode === 'phoneme' && tests.B.scoringMode === 'phoneme') {
                    finalY += 5;
                    const isPhonSig = isPhonemeDiffSig ? "YES - Significant Difference" : "NO - Within Critical Limits";
                    doc.text(`Phoneme Score Difference: ${isPhonSig}`, 20, finalY);
                }

                if (!isWordDiffSig && !(tests.A.scoringMode === 'phoneme' && isPhonemeDiffSig)) {
                    finalY += 5;
                    doc.text(`Comparative Ease of Listening Rating: ${tests.comparativeEase}/10`, 20, finalY);
                    finalY += 4;
                    let easeDesc = "No Difference";
                    if (tests.comparativeEase > 5) easeDesc = "New condition is Easier";
                    if (tests.comparativeEase < 5) easeDesc = "New condition is Harder";
                    doc.setFontSize(9);
                    doc.text(`(${easeDesc})`, 25, finalY);
                    doc.setFontSize(10);
                }

                finalY += 15;
                doc.text("Clinical Notes:", 20, finalY);
                doc.rect(20, finalY + 2, 170, 30);

                finalY += 50;
                doc.line(20, finalY, 80, finalY);
                doc.text("Provider Signature", 20, finalY + 5);

                doc.save(`NU6_Report_${patientName.replace(/\s/g, '_')}_${testDate}.pdf`);
            };

            const displayTitle = clinicSettings?.appTitle || 'NU-6 Phoneme Scorer';
            const getEffortColor = (val) => { if (val <= 4) return 'text-emerald-600'; if (val >= 6) return 'text-red-600'; return 'text-blue-600'; };
            const effortDelta = tests.B.effort - tests.A.effort;
            const showComparativeEase = !isWordDiffSig && !(tests.A.scoringMode === 'phoneme' && isPhonemeDiffSig);

            if (!dbReady) return <div className="min-h-screen flex items-center justify-center text-slate-500"><Loader className="w-8 h-8 mr-2"/> Initializing secure storage...</div>;
            if (isLocked) return <LoginModal isSetup={hasPassword} onLogin={() => setIsLocked(false)} />;

            return (
                <div className="min-h-screen bg-slate-100 p-4 md:p-8 print:p-0 print:bg-white">
                    <ListeningEffortScaleModal isOpen={showScaleModal} onClose={() => setShowScaleModal(false)} />
                    <CriticalDifferenceModal isOpen={showChartModal} onClose={() => setShowChartModal(false)} confidenceLevel={confidenceLevel} />
                    <PhonemeDisclaimerModal isOpen={showPhonemeModal} onClose={() => setShowPhonemeModal(false)} />
                    <LoadTestModal isOpen={showLoadModal} onClose={() => setShowLoadModal(false)} onLoad={handleLoadTest} />
                    <SettingsModal isOpen={showSettingsModal} onClose={() => setShowSettingsModal(false)} initialSettings={clinicSettings} onSave={handleSaveSettings} />
                    <ComparativeEaseScaleModal isOpen={showComparativeScaleModal} onClose={() => setShowComparativeScaleModal(false)} />

                    <div className="max-w-5xl mx-auto space-y-6">
                        {/* Header Controls */}
                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 print:hidden">
                            <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                                <div>
                                    <h1 className="text-2xl font-bold text-slate-800 flex items-center gap-2">
                                        <Calculator className="w-6 h-6 text-blue-600" />
                                        {displayTitle}
                                    </h1>
                                    <p className="text-slate-500 text-sm">Comparison Mode & Multi-list Support</p>
                                </div>
                                <div className="flex flex-wrap gap-2 justify-end">
                                    <button onClick={() => setShowSettingsModal(true)} className="flex items-center gap-2 px-3 py-2 bg-slate-100 text-slate-600 rounded-lg hover:bg-slate-200 transition text-sm font-medium"><SettingsIcon className="w-4 h-4"/></button>
                                    <button onClick={() => setShowLoadModal(true)} className="flex items-center gap-2 px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition text-sm font-medium"><Database className="w-4 h-4" /> Load Patient</button>
                                    <button onClick={handleExportDB} className="flex items-center gap-2 px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition text-sm font-medium"><Download className="w-4 h-4" /> Export DB (JSON)</button>
                                    <button onClick={handleExportFHIR} className="flex items-center gap-2 px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition text-sm font-medium"><Flame className="w-4 h-4" /> Export FHIR</button>
                                    <button onClick={handleExportPDF} className="flex items-center gap-2 px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition text-sm font-medium"><FileText className="w-4 h-4" /> PDF Report</button>
                                    <button onClick={handleSave} className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm font-medium"><Save className="w-4 h-4" /> Save (Local)</button>
                                    {currentTestId && (
                                        <button onClick={handleDeleteCurrentRecord} className="flex items-center gap-2 px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition text-sm font-medium"><Trash2 className="w-4 h-4" /> Delete</button>
                                    )}
                                    <button onClick={clearAllData} className={`flex items-center gap-2 px-4 py-2 rounded-lg transition text-sm font-medium ${clearConfirm ? 'bg-red-600 text-white hover:bg-red-700' : 'bg-red-100 text-red-700 hover:bg-red-200'}`}><RotateCcw className="w-4 h-4" /> {clearConfirm ? "Confirm?" : "New Test"}</button>
                                </div>
                            </div>
                            <div className="bg-slate-50 p-6 rounded-xl border border-slate-200 mb-6">
                                <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4">Patient Information</h3>
                                <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                                    <div><label className="block text-xs font-medium text-slate-500 mb-1">Patient Name</label><input type="text" value={patientName} onChange={(e) => setPatientName(e.target.value)} className="w-full px-3 py-2 rounded-lg border border-slate-300 text-sm" placeholder="Enter name..." /></div>
                                    <div><label className="block text-xs font-medium text-slate-500 mb-1">ID</label><input type="text" value={cNumber} onChange={(e) => setCNumber(e.target.value)} className="w-full px-3 py-2 rounded-lg border border-slate-300 text-sm" placeholder="Patient ID" /></div>
                                    <div><label className="block text-xs font-medium text-slate-500 mb-1">Test Date</label><input type="date" value={testDate} onChange={(e) => setTestDate(e.target.value)} className="w-full px-3 py-2 rounded-lg border border-slate-300 text-sm" /></div>
                                    <div className="flex items-end"><div className="bg-white p-3 rounded-lg text-xs text-slate-600 border border-slate-200 w-full h-[42px] flex items-center justify-center text-center">Comparison Mode Active</div></div>
                                </div>
                            </div>
                            <div className="flex space-x-1 bg-slate-100 p-1 rounded-lg w-fit">
                                <button onClick={() => setActiveTab('scoring')} className={`px-4 py-2 text-sm font-medium rounded-md tab-btn flex items-center gap-2 ${activeTab === 'scoring' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-600 hover:text-slate-900'}`}><CheckCircle2 className="w-4 h-4" /> Scoring Entry</button>
                                <button onClick={() => setActiveTab('comparison')} className={`px-4 py-2 text-sm font-medium rounded-md tab-btn flex items-center gap-2 ${activeTab === 'comparison' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-600 hover:text-slate-900'}`}><BarChart3 className="w-4 h-4" /> Comparison Results</button>
                                <button onClick={() => setActiveTab('history')} className={`px-4 py-2 text-sm font-medium rounded-md tab-btn flex items-center gap-2 ${activeTab === 'history' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-600 hover:text-slate-900'}`}><HistoryIcon className="w-4 h-4" /> Longitudinal History</button>
                            </div>
                        </div>

                        {activeTab === 'scoring' && (
                            <div className="space-y-6">
                                <div className="grid grid-cols-2 gap-4 print:hidden">
                                    {['A', 'B'].map(id => {
                                        const t = tests[id]; const s = id === 'A' ? statsA : statsB; const isActive = activeTestId === id;
                                        return (
                                            <button key={id} onClick={() => setActiveTestId(id)} className={`relative p-4 rounded-xl border-2 text-left transition-all ${isActive ? 'border-blue-500 bg-blue-50/50' : 'border-slate-200 bg-white hover:border-slate-300'}`}>
                                                <div className="flex justify-between items-start mb-2"><span className={`px-2 py-0.5 rounded text-xs font-bold ${isActive ? 'bg-blue-600 text-white' : 'bg-slate-200 text-slate-600'}`}>TEST {id}</span>{isActive && <span className="flex h-3 w-3 relative"><span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span><span className="relative inline-flex rounded-full h-3 w-3 bg-blue-500"></span></span>}</div>
                                                <div className="text-sm font-semibold text-slate-800">{t.condition}</div>
                                                <div className="text-xs text-slate-500 mb-2">{t.listId} {t.section}</div>
                                                <div className="flex gap-3 text-sm"><span className="font-bold text-slate-700">W: {s.wordPercent}%</span>{t.scoringMode === 'phoneme' && <span className="font-bold text-slate-700">P: {s.phonemePercent}%</span>}</div>
                                            </button>
                                        );
                                    })}
                                </div>
                                <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 print:hidden">
                                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
                                        <div className="lg:col-span-5 space-y-6">
                                            <div><label className="block text-xs font-medium text-slate-500 mb-2">Condition</label><div className="flex rounded-lg overflow-hidden border border-slate-200 mb-3">{(activeTestId === 'A' ? ['Unaided', 'Current Tech'] : ['Current Tech', 'New Tech']).map(c => (<button key={c} onClick={() => updateActiveTest('condition', c)} className={`flex-1 py-2 text-sm font-medium transition ${activeTest.condition === c ? 'bg-indigo-600 text-white' : 'bg-slate-50 hover:bg-slate-100 text-slate-600'}`}>{c}</button>))}</div>{(activeTest.condition === 'Current Tech' || activeTest.condition === 'New Tech') && (<div><input type="text" value={activeTest.deviceModel || ''} onChange={(e) => updateActiveTest('deviceModel', e.target.value)} className="w-full px-3 py-2 rounded-lg border border-slate-300 text-sm" placeholder="Enter Make/Model..." /></div>)}</div>
                                            <div><label className="block text-xs font-medium text-slate-500 mb-2">Scoring Mode</label><div className="flex rounded-lg overflow-hidden border border-slate-200"><button onClick={() => updateActiveTest('scoringMode', 'phoneme')} className={`flex-1 py-2 text-xs font-bold flex items-center justify-center gap-1 transition ${activeTest.scoringMode === 'phoneme' ? 'bg-slate-700 text-white' : 'bg-slate-50 text-slate-600 hover:bg-slate-100'}`}><ListChecks className="w-3 h-3" /> Phoneme</button><button onClick={() => updateActiveTest('scoringMode', 'word')} className={`flex-1 py-2 text-xs font-bold flex items-center justify-center gap-1 transition ${activeTest.scoringMode === 'word' ? 'bg-slate-700 text-white' : 'bg-slate-50 text-slate-600 hover:bg-slate-100'}`}><WholeWord className="w-3 h-3" /> Word</button></div></div>
                                        </div>
                                        <div className="lg:col-span-7 grid grid-cols-2 gap-4">
                                            <div><label className="block text-xs font-medium text-slate-500 mb-1">Word List</label><select value={activeTest.listId} onChange={(e) => updateActiveTest('listId', e.target.value)} className="w-full px-3 py-2 rounded-lg border border-slate-300 text-sm"><option value="1A">List 1A</option><option value="2A">List 2A</option><option value="3A">List 3A</option><option value="4A">List 4A</option></select></div>
                                            <div><label className="block text-xs font-medium text-slate-500 mb-1">Section</label><select value={activeTest.section} onChange={(e) => updateActiveTest('section', e.target.value)} className="w-full px-3 py-2 rounded-lg border border-slate-300 text-sm">{getSectionOptions(activeTestId).map(opt => (<option key={opt.val} value={opt.val}>{opt.label}</option>))}</select></div>
                                            <div><label className="block text-xs font-medium text-slate-500 mb-1">SPL (dBC)</label><input type="text" value={activeTest.level} onChange={(e) => updateActiveTest('level', e.target.value)} className="w-full px-3 py-2 rounded-lg border border-slate-300 text-sm" /></div>
                                            <div><label className="block text-xs font-medium text-slate-500 mb-1">SNR (dB)</label><input type="text" value={activeTest.snr} onChange={(e) => updateActiveTest('snr', e.target.value)} className="w-full px-3 py-2 rounded-lg border border-slate-300 text-sm" /></div>
                                        </div>
                                    </div>
                                </div>
                                {activeTest.scoringMode === 'phoneme' && (<DiagnosticsPanel stats={activeStats} scores={activeTest.scores} listId={activeTest.listId} />)}
                                <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden print:shadow-none print:border-2 print:border-black">
                                    <div className="bg-slate-50 px-4 py-3 border-b border-slate-200 flex justify-between items-center print:bg-slate-200">
                                        <div className="font-bold text-slate-700 flex items-center gap-2">Scoring: Test {activeTestId} <span className="font-normal text-slate-500 mx-1">|</span> {activeTest.listId}{activeTest.limitTo10 && <span className="ml-2 px-2 py-0.5 bg-orange-100 text-orange-700 text-xs rounded-full border border-orange-200 flex items-center gap-1"><AlertCircle className="w-3 h-3"/> Limited to 10 Words</span>}</div>
                                        <div className="flex gap-2 print:hidden"><button onClick={() => markAll(true)} className="text-xs px-2 py-1 bg-emerald-100 text-emerald-700 rounded hover:bg-emerald-200 font-medium">Mark All</button></div>
                                    </div>
                                    <table className="w-full text-left text-sm">
                                        <thead className="bg-slate-50 border-b border-slate-200 text-xs uppercase text-slate-500 print:hidden"><tr><th className="px-4 py-2 w-10">#</th><th className="px-4 py-2">Word</th>{activeTest.scoringMode === 'phoneme' && (<React.Fragment><th className="px-2 py-2 text-center">I</th><th className="px-2 py-2 text-center">M</th><th className="px-2 py-2 text-center">F</th></React.Fragment>)}<th className="px-4 py-2 text-center">{activeTest.scoringMode === 'phoneme' ? 'Word' : 'Result'}</th></tr></thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {activeStats.visibleWords.map((word) => {
                                                const listId = activeTest.listId; const phonemeScores = word.p.map((p, idx) => { if (p === '-') return null; return activeTest.scores[`${listId}_${word.i}_${idx}`]; }).filter(val => val !== null); const isWordCorrect = phonemeScores.every(s => s === true); const isWordFullyIncorrect = phonemeScores.every(s => s === false);
                                                return (
                                                    <tr key={word.i} className="hover:bg-slate-50"><td className="px-4 py-2 text-slate-400 font-mono text-xs">{word.i}</td><td className="px-4 py-2 font-bold text-slate-800">{word.w}</td>
                                                        {activeTest.scoringMode === 'phoneme' ? (<React.Fragment>{word.p.map((phoneme, pIndex) => { const isCorrect = !!activeTest.scores[`${listId}_${word.i}_${pIndex}`]; const isPlaceholder = phoneme === '-'; return (<td key={pIndex} className="px-1 py-1 text-center">{!isPlaceholder ? (<button onClick={() => togglePhoneme(word.i, pIndex)} className={`w-10 h-8 rounded flex items-center justify-center font-medium text-base border transition-colors ${isCorrect ? 'bg-emerald-50 border-emerald-200 text-emerald-700 hover:bg-emerald-100 print:border-none print:text-black print:font-bold' : 'bg-white border-slate-200 text-slate-400 hover:border-red-300 hover:text-red-500 hover:bg-red-50'}`}><span className="ipa-text">{phoneme}</span></button>) : <span className="text-slate-300">—</span>}</td>); })}<td className="px-4 py-2 text-center print:hidden"><div className="flex items-center justify-center gap-2"><button onClick={() => toggleWordCorrect(word.i)} title={isWordCorrect ? "Clear Word" : "Mark Whole Word Correct"} className={`w-8 h-8 rounded-full border flex items-center justify-center transition-colors ${isWordCorrect ? 'bg-emerald-100 border-emerald-300 text-emerald-700' : 'bg-slate-50 border-slate-200 text-slate-400 hover:bg-emerald-50 hover:text-emerald-500 hover:border-emerald-200'}`}><Check className="w-4 h-4" /></button></div></td></React.Fragment>) : (<td className="px-4 py-2 text-center"><div className="flex gap-2 justify-center"><button onClick={() => setWordScore(word.i, true)} className={`flex-1 max-w-[80px] py-1.5 rounded-md font-bold text-xs border transition-colors flex items-center justify-center gap-1 ${isWordCorrect ? 'bg-emerald-600 text-white border-emerald-700 shadow-sm' : 'bg-white border-slate-200 text-slate-400 hover:bg-emerald-50 hover:text-emerald-600'}`}><Check className="w-3 h-3" /> Correct</button><button onClick={() => setWordScore(word.i, false)} className={`flex-1 max-w-[80px] py-1.5 rounded-md font-bold text-xs border transition-colors flex items-center justify-center gap-1 ${isWordFullyIncorrect ? 'bg-red-600 text-white border-red-700 shadow-sm' : 'bg-white border-slate-200 text-slate-400 hover:bg-red-50 hover:text-red-600'}`}><X className="w-3 h-3" /> Incorrect</button></div></td>)}
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {activeTab === 'comparison' && (
                            <div className="space-y-6">
                                <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden print:shadow-none print:border-2 print:border-black">
                                    <div className="bg-slate-800 text-white px-6 py-4 flex items-center justify-between print:bg-black print:text-white">
                                        <h2 className="text-lg font-bold flex items-center gap-2"><BarChart3 className="w-5 h-5" /> Score Comparison</h2>
                                        <div className="text-right"><div className="text-xs opacity-75 font-mono">{testDate} • {patientName} • #{cNumber}</div><div className="text-[10px] opacity-50 mt-1">Thornton & Raffin (1978) Model</div></div>
                                    </div>
                                    <div className="p-6">
                                        <div className="flex justify-end mb-4 print:hidden"><div className="bg-slate-100 p-1 rounded-lg flex items-center gap-2 text-sm"><span className="px-2 text-xs font-semibold text-slate-500 uppercase">Confidence Level</span><button onClick={() => setConfidenceLevel(95)} className={`px-3 py-1 rounded-md transition ${confidenceLevel === 95 ? 'bg-white shadow text-blue-700 font-bold' : 'text-slate-600 hover:bg-slate-200'}`}>95%</button><button onClick={() => setConfidenceLevel(80)} className={`px-3 py-1 rounded-md transition ${confidenceLevel === 80 ? 'bg-white shadow text-blue-700 font-bold' : 'text-slate-600 hover:bg-slate-200'}`}>80%</button><button onClick={() => setShowChartModal(true)} className="px-3 py-1 bg-white hover:bg-slate-200 text-slate-600 rounded-md transition border border-slate-200 flex items-center gap-1"><TrendingUp className="w-3 h-3" /> View Chart</button></div></div>
                                        <div className="grid grid-cols-3 gap-8 mb-8">
                                            <div className="bg-slate-50 rounded-lg p-4 border border-slate-200 print:bg-white print:border-black"><div className="text-xs font-bold text-slate-500 uppercase mb-1">Test A (Baseline)</div><div className="text-lg font-bold text-slate-900 mb-2">{tests.A.condition}</div><div className="text-sm text-slate-600 mb-4 space-y-1"><div>List: {tests.A.listId}</div><div>Level: {tests.A.level || '--'} dBC</div><div>SNR: {tests.A.snr || '--'} dB</div></div><div className="space-y-2 border-t border-slate-200 pt-3"><div className="flex justify-between items-center"><span className="text-sm text-slate-600">Word Score</span><span className="text-xl font-bold text-blue-600">{statsA.wordPercent}%</span></div>{tests.A.scoringMode === 'phoneme' && (<div className="flex justify-between items-center"><span className="text-sm text-slate-600">Phoneme Score</span><span className="text-lg font-semibold text-slate-700">{statsA.phonemePercent}%</span></div>)}</div></div>
                                            <div className="flex flex-col items-center justify-center text-center"><div className="mb-2 text-xs font-bold text-slate-400 uppercase">Difference (B - A)</div><div className={`text-3xl font-bold mb-1 ${statsB.wordPercent - statsA.wordPercent >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>{statsB.wordPercent - statsA.wordPercent > 0 ? '+' : ''}{statsB.wordPercent - statsA.wordPercent}%</div><div className="text-sm text-slate-500 mb-6">Word Recognition</div>{(tests.A.scoringMode === 'phoneme' && tests.B.scoringMode === 'phoneme') && (<React.Fragment><div className={`text-2xl font-bold mb-1 ${statsB.phonemePercent - statsA.phonemePercent >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>{statsB.phonemePercent - statsA.phonemePercent > 0 ? '+' : ''}{statsB.phonemePercent - statsA.phonemePercent}%</div><div className="text-sm text-slate-500 mb-6">Phoneme Recognition</div></React.Fragment>)}</div>
                                            <div className="bg-slate-50 rounded-lg p-4 border border-slate-200 print:bg-white print:border-black"><div className="text-xs font-bold text-slate-500 uppercase mb-1">Test B (Comparison)</div><div className="text-lg font-bold text-slate-900 mb-2">{tests.B.condition}</div><div className="text-sm text-slate-600 mb-4 space-y-1"><div>List: {tests.B.listId}</div><div>Level: {tests.B.level || '--'} dBC</div><div>SNR: {tests.B.snr || '--'} dB</div></div><div className="space-y-2 border-t border-slate-200 pt-3"><div className="flex justify-between items-center"><span className="text-sm text-slate-600">Word Score</span><span className="text-xl font-bold text-blue-600">{statsB.wordPercent}%</span></div>{tests.B.scoringMode === 'phoneme' && (<div className="flex justify-between items-center"><span className="text-sm text-slate-600">Phoneme Score</span><span className="text-lg font-semibold text-slate-700">{statsB.phonemePercent}%</span></div>)}</div></div>
                                        </div>

                                        {/* Comparative Ease Slider */}
                                        {showComparativeEase && (
                                            <div className="mb-6 p-4 bg-slate-50 rounded-lg border border-slate-200">
                                                <div className="flex justify-between items-center mb-2">
                                                    <div className="flex items-center gap-2">
                                                        <label className="text-sm font-bold text-slate-700">Comparative Ease of Listening</label>
                                                        <button onClick={() => setShowComparativeScaleModal(true)} className="text-[10px] text-blue-600 hover:underline flex items-center gap-1">
                                                            <HelpCircle className="w-3 h-3" /> View Scale
                                                        </button>
                                                    </div>
                                                    <span className="text-xs text-slate-500 italic">Rate how much easier/harder Condition B is compared to A</span>
                                                </div>
                                                <div className="flex items-center gap-3">
                                                    <span className="text-xs font-bold text-slate-500 uppercase">Harder</span>
                                                    <div className="flex-1 relative">
                                                        <input
                                                            type="range"
                                                            min="0"
                                                            max="10"
                                                            value={tests.comparativeEase}
                                                            onChange={(e) => updateComparativeEase(parseInt(e.target.value))}
                                                            className="w-full h-2 bg-gradient-to-r from-red-300 via-slate-300 to-emerald-300 rounded-lg appearance-none cursor-pointer"
                                                        />
                                                        <div className="flex justify-between text-[10px] text-slate-400 mt-1 px-1">
                                                            <span>0</span>
                                                            <span>5 (No Diff)</span>
                                                            <span>10</span>
                                                        </div>
                                                    </div>
                                                    <span className="text-xs font-bold text-slate-500 uppercase">Easier</span>
                                                    <span className={`font-bold text-lg w-8 text-center ${tests.comparativeEase > 5 ? 'text-emerald-600' : tests.comparativeEase < 5 ? 'text-red-600' : 'text-slate-600'}`}>{tests.comparativeEase}</span>
                                                </div>
                                            </div>
                                        )}

                                        <div className="border border-slate-200 rounded-lg overflow-hidden mb-6"><table className="w-full text-sm"><thead className="bg-slate-100 text-slate-600 font-semibold border-b border-slate-200"><tr><th className="px-4 py-2 text-left">Metric (N)</th><th className="px-4 py-2 text-center w-24">Test A</th><th className="px-4 py-2 text-center w-32 bg-slate-50">Critical Range <span className="text-[10px] text-slate-400 block font-normal">({confidenceLevel}%)</span></th><th className="px-4 py-2 text-center w-24">Test B</th><th className="px-4 py-2 text-center w-32">Significant?</th></tr></thead><tbody className="divide-y divide-slate-100"><tr><td className="px-4 py-3 font-medium text-slate-800">Word Score <span className="block text-xs text-slate-400 font-normal">N = {statsA.totalWords}</span></td><td className="px-4 py-3 text-center text-slate-700 font-bold">{statsA.wordPercent}%</td><td className="px-4 py-3 text-center text-slate-500 bg-slate-50 text-xs font-mono">{wordCriticalLimits.lower}% - {wordCriticalLimits.upper}%</td><td className="px-4 py-3 text-center text-slate-700 font-bold">{statsB.wordPercent}%</td><td className="px-4 py-3 text-center">{isWordDiffSig ? <span className="inline-flex items-center gap-1 text-emerald-600 font-bold bg-emerald-50 px-2 py-1 rounded text-xs"><Check className="w-3 h-3" /> Yes</span> : <span className="inline-flex items-center gap-1 text-red-600 font-bold bg-red-50 px-2 py-1 rounded text-xs"><X className="w-3 h-3" /> No</span>}</td></tr>{(tests.A.scoringMode === 'phoneme' && tests.B.scoringMode === 'phoneme') && (<tr><td className="px-4 py-3 font-medium text-slate-800">Phoneme Score <span className="block text-xs text-slate-400 font-normal">N = {statsA.totalPhonemes}</span></td><td className="px-4 py-3 text-center text-slate-700 font-bold">{statsA.phonemePercent}%</td><td className="px-4 py-3 text-center text-slate-500 bg-slate-50 text-xs font-mono">{phonemeCriticalLimits.lower}% - {phonemeCriticalLimits.upper}%</td><td className="px-4 py-3 text-center text-slate-700 font-bold">{statsB.phonemePercent}%</td><td className="px-4 py-3 text-center">{isPhonemeDiffSig ? <span className="inline-flex items-center gap-1 text-emerald-600 font-bold bg-emerald-50 px-2 py-1 rounded text-xs"><Check className="w-3 h-3" /> Yes</span> : <span className="inline-flex items-center gap-1 text-red-600 font-bold bg-red-50 px-2 py-1 rounded text-xs"><X className="w-3 h-3" /> No</span>}</td></tr>)}</tbody></table></div>
                                        <div><label className="block text-xs font-bold uppercase text-slate-500 mb-2">Clinical Interpretation / Notes</label><textarea className="w-full border border-slate-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-blue-500 h-24" placeholder="Enter notes comparing the two conditions..."></textarea></div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'history' && (
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 print:shadow-none print:border-2 print:border-black">
                                <HistoryChart cNumber={cNumber} />
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
